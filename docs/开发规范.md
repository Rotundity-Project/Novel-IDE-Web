# Novel-IDE-Web 开发规范文档

## 1. 代码规范

### 1.1 TypeScript 规范

#### 类型定义
```typescript
// ✅ 推荐：使用 interface 定义对象类型
interface User {
  id: string;
  name: string;
  email: string;
}

// ✅ 推荐：使用 type 定义联合类型
type Status = 'active' | 'inactive' | 'pending';

// ✅ 推荐：泛型命名使用 T, U, V 或描述性名称
function map<T, U>(items: T[], fn: (item: T) => U): U[] {
  return items.map(fn);
}

// ❌ 避免：使用 any
function process(data: any) { }

// ✅ 使用：unknown
function process(data: unknown) {
  if (typeof data === 'string') { }
}
```

#### 变量命名
```typescript
// ✅ 驼峰命名法
const userName = 'John';
const isActive = true;

// ✅ 常量大写
const MAX_RETRIES = 3;
const API_BASE_URL = 'https://api.example.com';

// ✅ 私有变量前缀下划线
class UserService {
  private _httpClient: HttpClient;

  constructor() {
    this._httpClient = new HttpClient();
  }
}
```

#### 函数命名
```typescript
// ✅ 动词开头，描述性命名
function getUserById(id: string): Promise<User> { }

function createWork(data: CreateWorkDto): Promise<Work> { }

function isUserAdmin(user: User): boolean { }

// ✅ 事件处理函数用 handle 前缀
function handleSubmit(event: FormEvent) { }
function handleUserClick(userId: string) { }
```

#### 异步处理
```typescript
// ✅ 使用 async/await
async function fetchUser(id: string): Promise<User> {
  const response = await fetch(`/api/users/${id}`);
  const data = await response.json();
  return data;
}

// ✅ 错误处理
async function fetchUser(id: string): Promise<User> {
  try {
    const response = await fetch(`/api/users/${id}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch user:', error);
    throw error;
  }
}
```

### 1.2 React 规范

#### 组件定义
```typescript
// ✅ 使用函数组件 + Hooks
import React, { useState, useEffect } from 'react';

interface Props {
  title: string;
  onSave: (data: string) => void;
}

export function Editor({ title, onSave }: Props) {
  const [content, setContent] = useState('');

  useEffect(() => {
    // 初始化逻辑
  }, []);

  return (
    <div>
      <h1>{title}</h1>
      <textarea value={content} onChange={(e) => setContent(e.target.value)} />
      <button onClick={() => onSave(content)}>保存</button>
    </div>
  );
}

// ✅ 默认导出
export default Editor;
```

#### Hooks 使用
```typescript
// ✅ 自定义 Hook 命名以 use 开头
function useUser(id: string) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchUser(id).then(setUser).finally(() => setLoading(false));
  }, [id]);

  return { user, loading };
}

// ✅ Hooks 只在顶层调用
function Component() {
  const [state, setState] = useState(null);  // ✅ 顶层

  if (condition) {
    // ❌ 不要在条件中使用 Hooks
    // const [data] = useState(null);
  }

  // ✅ 顶层
  useEffect(() => {}, []);
}
```

#### 性能优化
```typescript
// ✅ 使用 memo 避免不必要的重渲染
const ExpensiveComponent = React.memo(({ data }: Props) => {
  return <div>{/* expensive rendering */}</div>;
});

// ✅ 使用 useCallback 缓存函数
const handleClick = useCallback((id: string) => {
  onAction(id);
}, [onAction]);

// ✅ 使用 useMemo 缓存计算结果
const filteredItems = useMemo(
  () => items.filter(item => item.active),
  [items]
);
```

### 1.3 样式规范

#### Tailwind CSS
```typescript
// ✅ 使用 Tailwind 类名
<div className="bg-gray-100 p-4 rounded-lg">
  <h2 className="text-xl font-bold">标题</h2>
</div>

// ✅ 使用自定义配置的语义类
<div className="card">
  <h2 className="card-title">标题</h2>
</div>

// ❌ 避免：内联样式
<div style={{ backgroundColor: '#f3f3f3', padding: '16px' }}>
```

#### CSS 模块（如需要）
```css
/* Editor.module.css */
.container {
  display: flex;
  flex-direction: column;
}

.title {
  font-size: 24px;
  font-weight: bold;
}
```

```typescript
import styles from './Editor.module.css';

<div className={styles.container}>
  <h2 className={styles.title}>标题</h2>
</div>
```

---

## 2. Git 规范

### 2.1 分支策略

```
main (主分支)
  │
  ├── develop (开发分支)
  │     │
  │     ├── feature/xxx (功能分支)
  │     ├── bugfix/xxx (修复分支)
  │     └── hotfix/xxx (紧急修复)
  │
  └── release/vX.X.X (发布分支)
```

#### 分支命名
- `feature/功能描述` - 新功能开发
- `bugfix/问题描述` - bug 修复
- `hotfix/紧急问题描述` - 紧急修复（从 main 分出）
- `release/vX.X.X` - 版本发布

### 2.2 提交信息规范

#### Conventional Commits
```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type 类型
- `feat`: 新功能
- `fix`: bug 修复
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具相关

#### 示例
```
feat(editor): 添加 AI 续写功能

- 集成 OpenAI API
- 实现流式输出
- 添加停止生成按钮

Closes #123
```

```
fix(auth): 修复刷新 token 无效问题

在 token 过期后正确处理刷新逻辑

Fixes #456
```

### 2.3 Pull Request 规范

#### PR 标题
```
[类型] 简短描述

例如：[feat] 添加 AI 续写功能
```

#### PR 描述模板
```markdown
## 变更说明
简要描述这次变更的内容

## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 文档更新
- [ ] 其他

## 测试
- [ ] 已添加单元测试
- [ ] 已添加集成测试
- [ ] 已手动测试

## 关联 Issue
Closes #123
```

#### PR 审查清单
- [ ] 代码符合项目规范
- [ ] 没有引入新的警告或错误
- [ ] 已更新相关文档
- [ ] 已添加必要的测试
- [ ] 已通过所有测试

---

## 3. 文件组织规范

### 3.1 前端目录结构
```
client/src/
├── assets/           # 静态资源
├── components/       # 公共组件
│   ├── ui/          # 基础 UI 组件
│   └── editor/      # 编辑器相关组件
├── hooks/           # 自定义 Hooks
├── pages/           # 页面组件
├── routes/          # 路由配置
├── stores/          # 状态管理
├── services/        # API 服务
├── types/           # TypeScript 类型
├── utils/           # 工具函数
└── styles/          # 全局样式
```

### 3.2 后端目录结构
```
server/src/
├── controllers/     # 控制器
├── services/        # 服务层
├── models/          # 数据模型
├── repositories/    # 数据访问
├── middleware/      # 中间件
├── routes/          # 路由
├── validators/      # 数据验证
├── utils/           # 工具函数
├── types/           # TypeScript 类型
├── config/          # 配置文件
├── llm/             # LLM 集成
├── agents/          # 智能体系统
└── tests/           # 测试文件
```

### 3.3 命名规范

#### 文件名
- 组件: `PascalCase` - `UserProfile.tsx`, `Editor.tsx`
- 工具函数: `camelCase` - `formatDate.ts`, `validateEmail.ts`
- 类型: `camelCase` - `userTypes.ts`, `apiTypes.ts`
- 常量: `UPPER_CASE` - `API_CONSTANTS.ts`

#### 目录名
- `kebab-case` - `user-profile/`, `api-client/`

---

## 4. 代码注释规范

### 4.1 JSDoc 注释

```typescript
/**
 * 获取用户信息
 * @param userId - 用户 ID
 * @returns 用户信息
 * @throws {Error} 当用户不存在时抛出错误
 */
async function getUser(userId: string): Promise<User> {
  const user = await db.users.findUnique({ where: { id: userId } });
  if (!user) {
    throw new Error('User not found');
  }
  return user;
}
```

### 4.2 复杂逻辑注释

```typescript
// 计算章节字数，排除 Markdown 标记
function countWords(content: string): number {
  // 移除 Markdown 标记：标题、链接、图片等
  const cleanContent = content
    .replace(/#{1,6}\s/g, '')        // 标题
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')  // 链接
    .replace(/!\[([^\]]*)\]\([^)]+\)/g, '$1')  // 图片
    .replace(/`([^`]+)`/g, '$1');     // 代码

  // 计算中文字符和英文单词
  const chineseChars = cleanContent.match(/[\u4e00-\u9fa5]/g) || [];
  const englishWords = cleanContent.match(/[a-zA-Z]+/g) || [];

  return chineseChars.length + englishWords.length;
}
```

### 4.3 TODO 注释

```typescript
// TODO: 实现批量导入功能 (Issue #123)
// FIXME: 处理边界情况
// HACK: 临时解决方案，需要重构
// NOTE: 这里的逻辑可能需要优化
```

---

## 5. 测试规范

### 5.1 单元测试

```typescript
import { describe, it, expect } from 'vitest';
import { countWords } from './utils';

describe('countWords', () => {
  it('should count Chinese characters', () => {
    expect(countWords('你好世界')).toBe(4);
  });

  it('should count English words', () => {
    expect(countWords('Hello world')).toBe(2);
  });

  it('should ignore Markdown syntax', () => {
    expect(countWords('# 标题')).toBe(2);
  });
});
```

### 5.2 集成测试

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import request from 'supertest';
import app from '../src/app';

describe('POST /api/v1/works', () => {
  let authToken: string;

  beforeAll(async () => {
    // 登录获取 token
    const res = await request(app)
      .post('/api/v1/auth/login')
      .send({ email: 'test@example.com', password: 'password' });
    authToken = res.body.data.tokens.accessToken;
  });

  it('should create a work', async () => {
    const res = await request(app)
      .post('/api/v1/works')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ title: '测试作品' });

    expect(res.status).toBe(201);
    expect(res.body.data.title).toBe('测试作品');
  });

  it('should return 401 without auth', async () => {
    const res = await request(app)
      .post('/api/v1/works')
      .send({ title: '测试作品' });

    expect(res.status).toBe(401);
  });
});
```

### 5.3 测试覆盖率要求

- 核心业务逻辑: ≥ 90%
- 工具函数: ≥ 100%
- 组件: ≥ 80%
- 整体: ≥ 70%

---

## 6. 错误处理规范

### 6.1 错误定义

```typescript
// 自定义错误类
class AppError extends Error {
  constructor(
    public code: string,
    public statusCode: number,
    message: string
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// 使用
throw new AppError('USER_NOT_FOUND', 404, '用户不存在');
```

### 6.2 错误中间件

```typescript
export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  console.error('Error:', err);

  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      success: false,
      error: {
        code: err.code,
        message: err.message,
      },
    });
  }

  // 未知错误
  res.status(500).json({
    success: false,
    error: {
      code: 'INTERNAL_ERROR',
      message: '服务器内部错误',
    },
  });
}
```

---

## 7. 性能优化规范

### 7.1 前端优化

```typescript
// ✅ 懒加载组件
const Editor = lazy(() => import('./pages/Editor'));

// ✅ 图片懒加载
<img loading="lazy" src="..." alt="..." />

// ✅ 代码分割
import('./heavy-module').then(module => {
  module.doSomething();
});

// ✅ 防抖
const debouncedSearch = debounce(handleSearch, 300);
```

### 7.2 后端优化

```typescript
// ✅ 使用数据库索引
await prisma.work.findMany({
  where: { userId },
  orderBy: { updatedAt: 'desc' },
});

// ✅ 分页查询
await prisma.chapter.findMany({
  where: { workId },
  take: 20,
  skip: (page - 1) * 20,
});

// ✅ 缓存
const cached = await redis.get(`work:${id}`);
if (cached) return JSON.parse(cached);
```

---

## 8. 安全规范

### 8.1 输入验证

```typescript
// ✅ 使用验证库
import { body, validationResult } from 'express-validator';

app.post('/api/v1/works',
  [
    body('title').isLength({ min: 1, max: 255 }),
  ],
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // 处理请求
  }
);
```

### 8.2 敏感信息

```typescript
// ❌ 不要硬编码敏感信息
const apiKey = 'sk-xxx';

// ✅ 使用环境变量
const apiKey = process.env.API_KEY;
```

---

## 9. 文档规范

### 9.1 README 更新

添加新功能时更新：
- 功能说明
- 使用示例
- 配置说明

### 9.2 代码内文档

为公共 API 添加 JSDoc 注释：
- 函数/类的作用
- 参数说明
- 返回值说明
- 异常说明

---

## 10. 工具配置

### 10.1 ESLint

```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": ["error", { "argsIgnorePattern": "^_" }],
    "react/react-in-jsx-scope": "off"
  }
}
```

### 10.2 Prettier

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "always"
}
```

---

**文档版本**: v1.0
**最后更新**: 2026-02-11
