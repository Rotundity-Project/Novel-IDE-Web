# Novel-Studio-Web 数据库设计文档

## 1. 数据库概述

### 1.1 技术选型
- **主数据库**: PostgreSQL 15+
- **ORM**: Drizzle ORM
- **缓存数据库**: Redis 7+
- **全文搜索**: Meilisearch (推荐) 或 PostgreSQL 内置
- **对象存储**: AWS S3 / 阿里云 OSS / MinIO

### 1.2 设计原则
- 数据规范化与反规范化平衡
- 支持 JSON 存储灵活字段
- 充分利用 PostgreSQL 特性（JSONB、全文搜索、索引）
- 考虑水平扩展性

### 1.3 命名规范
- 表名: 小写蛇形命名法（snake_case）
- 字段名: 小写蛇形命名法
- 主键: `id` (UUID)
- 外键: `{表名}_id` (UUID)
- 时间戳: `created_at`, `updated_at`
- 布尔字段: `is_` 前缀

---

## 2. 核心表设计

### 2.1 用户表 (users)
```sql
CREATE TABLE users (
  -- 主键
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 基本信息
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,

  -- 个人资料
  avatar_url VARCHAR(500),
  bio TEXT,
  website VARCHAR(255),

  -- 用户状态
  is_active BOOLEAN DEFAULT TRUE,
  is_verified BOOLEAN DEFAULT FALSE,
  verification_token VARCHAR(255),
  verification_expires_at TIMESTAMP,

  -- 订阅信息
  plan VARCHAR(50) DEFAULT 'free', -- free, pro, enterprise
  subscription_expires_at TIMESTAMP,

  -- 时间戳
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_is_active ON users(is_active);
```

### 2.2 第三方账号表 (oauth_accounts)
```sql
CREATE TABLE oauth_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL, -- github, google, wechat
  provider_user_id VARCHAR(255) NOT NULL,
  access_token TEXT,
  refresh_token TEXT,
  expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(provider, provider_user_id)
);

CREATE INDEX idx_oauth_accounts_user_id ON oauth_accounts(user_id);
```

### 2.3 用户设置表 (user_settings)
```sql
CREATE TABLE user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- 主题设置
  theme VARCHAR(20) DEFAULT 'dark', -- dark, light

  -- 编辑器设置
  editor_font_family VARCHAR(100) DEFAULT 'Georgia',
  editor_font_size INTEGER DEFAULT 16,
  editor_line_height DECIMAL(3,1) DEFAULT 1.8,
  editor_paragraph_spacing INTEGER DEFAULT 8,
  editor_word_wrap BOOLEAN DEFAULT TRUE,

  -- 界面设置
  show_sidebar BOOLEAN DEFAULT TRUE,
  show_outline BOOLEAN DEFAULT TRUE,
  show_status_bar BOOLEAN DEFAULT TRUE,

  -- AI 设置
  default_agent_id UUID,
  default_model_id VARCHAR(100),
  auto_save_interval INTEGER DEFAULT 30, -- 秒

  -- 导出设置
  export_format VARCHAR(20) DEFAULT 'md',
  export_include_metadata BOOLEAN DEFAULT TRUE,

  -- 语言
  language VARCHAR(10) DEFAULT 'zh-CN',

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(user_id)
);

CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
```

### 2.4 作品表 (works)
```sql
CREATE TABLE works (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- 基本信息
  title VARCHAR(255) NOT NULL,
  description TEXT,
  cover_url VARCHAR(500),

  -- 作品设置
  genre VARCHAR(100), -- 科幻、玄幻、都市等
  tags TEXT[],
  status VARCHAR(50) DEFAULT 'draft', -- draft, publishing, completed, paused

  -- 作品设置 JSONB
  settings JSONB DEFAULT '{
    "defaultAgentId": null,
    "chapterNamingPattern": "第{n}章",
    "wordCountGoal": 100000,
    "enableAiSuggestions": true,
    "worldview": {}
  }'::jsonb,

  -- 统计信息
  chapters_count INTEGER DEFAULT 0,
  total_words INTEGER DEFAULT 0,
  reading_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,

  -- 发布信息（未来）
  is_published BOOLEAN DEFAULT FALSE,
  published_at TIMESTAMP,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  deleted_at TIMESTAMP -- 软删除
);

-- 索引
CREATE INDEX idx_works_user_id ON works(user_id);
CREATE INDEX idx_works_status ON works(status);
CREATE INDEX idx_works_genre ON works(genre);
CREATE INDEX idx_works_created_at ON works(created_at DESC);
CREATE INDEX idx_works_updated_at ON works(updated_at DESC);
CREATE INDEX idx_works_deleted_at ON works(deleted_at) WHERE deleted_at IS NOT NULL;

-- 全文搜索索引
CREATE INDEX idx_works_search ON works USING GIN(to_tsvector('chinese', title || ' ' || COALESCE(description, '')));
```

### 2.5 章节表 (chapters)
```sql
CREATE TABLE chapters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID NOT NULL REFERENCES works(id) ON DELETE CASCADE,

  -- 基本信息
  title VARCHAR(255),
  content TEXT,

  -- 组织
  order_index INTEGER NOT NULL,

  -- 元数据
  word_count INTEGER DEFAULT 0,
  reading_time INTEGER, -- 预计阅读时间（分钟）

  -- 标签
  tags TEXT[], -- 动作、对话、情感等

  -- 统计
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,

  -- AI 辅助信息
  last_ai_generated_at TIMESTAMP,
  ai_version_count INTEGER DEFAULT 0,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  deleted_at TIMESTAMP,

  -- 约束
  UNIQUE(work_id, order_index)
);

-- 索引
CREATE INDEX idx_chapters_work_id ON chapters(work_id);
CREATE INDEX idx_chapters_work_order ON chapters(work_id, order_index);
CREATE INDEX idx_chapters_tags ON chapters USING GIN(tags);
CREATE INDEX idx_chapters_deleted_at ON chapters(deleted_at) WHERE deleted_at IS NOT NULL;

-- 全文搜索
CREATE INDEX idx_chapters_search ON chapters USING GIN(to_tsvector('chinese', COALESCE(title, '') || ' ' || COALESCE(content, '')));
```

### 2.6 版本历史表 (version_history)
```sql
CREATE TABLE version_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chapter_id UUID NOT NULL REFERENCES chapters(id) ON DELETE CASCADE,

  -- 内容
  content TEXT NOT NULL,

  -- 统计
  word_count INTEGER,
  diff_summary JSONB, -- 变化摘要

  -- 版本信息
  version_number INTEGER,
  change_type VARCHAR(50), -- manual, ai, autosave

  -- AI 信息（如果是 AI 生成的）
  agent_id UUID,
  model_id VARCHAR(100),
  ai_generation_id UUID,

  created_at TIMESTAMP DEFAULT NOW(),

  -- 定期清理：只保留最近 30 天
  valid_until TIMESTAMP DEFAULT (NOW() + INTERVAL '30 days')
);

-- 索引
CREATE INDEX idx_version_history_chapter_id ON version_history(chapter_id);
CREATE INDEX idx_version_history_chapter_created ON version_history(chapter_id, created_at DESC);
CREATE INDEX idx_version_history_valid_until ON version_history(valid_until) WHERE valid_until < NOW();

-- 分区（可选：大数据量时）
-- CREATE TABLE version_history_2026_02 PARTITION OF version_history
--   FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
```

### 2.7 角色表 (characters)
```sql
CREATE TABLE characters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID NOT NULL REFERENCES works(id) ON DELETE CASCADE,

  -- 基本信息
  name VARCHAR(100) NOT NULL,
  alias VARCHAR(100), -- 别名
  description TEXT,
  avatar_url VARCHAR(500),

  -- 角色属性
  attributes JSONB DEFAULT '{
    "age": null,
    "gender": null,
    "appearance": "",
    "personality": "",
    "background": "",
    "motivation": "",
    "flaws": [],
    "strengths": []
  }'::jsonb,

  -- 关系
  relationships JSONB DEFAULT '[]'::jsonb, -- 关系图谱

  -- 首次出现
  first_appearance_chapter_id UUID REFERENCES chapters(id),
  first_appearance_position INTEGER,

  -- 统计
  appearance_count INTEGER DEFAULT 0, -- 出现次数

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_characters_work_id ON characters(work_id);
CREATE INDEX idx_characters_name ON characters(name);
CREATE INDEX idx_characters_work_name ON characters(work_id, name);
```

### 2.8 场景表 (scenes)
```sql
CREATE TABLE scenes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID NOT NULL REFERENCES works(id),
  chapter_id UUID REFERENCES chapters(id) ON DELETE CASCADE,

  -- 基本信息
  title VARCHAR(255),
  description TEXT,

  -- 场景信息
  location VARCHAR(255), -- 地点
  time_period VARCHAR(255), -- 时间
  mood VARCHAR(100), -- 氛围

  -- 场景中出现的角色
  character_ids UUID[], -- 角色列表

  -- 范围
  start_position INTEGER,
  end_position INTEGER,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_scenes_work_id ON scenes(work_id);
CREATE INDEX idx_scenes_chapter_id ON scenes(chapter_id);
```

### 2.9 世界观设定表 (worldview)
```sql
CREATE TABLE worldview (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID NOT NULL REFERENCES works(id) ON DELETE CASCADE,

  -- 分类
  category VARCHAR(100), -- geography, history, magic, technology, culture

  -- 内容
  title VARCHAR(255) NOT NULL,
  content TEXT,
  parent_id UUID REFERENCES worldview(id), -- 支持层级结构

  -- 关联角色
  character_ids UUID[],

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_worldview_work_id ON worldview(work_id);
CREATE INDEX idx_worldview_category ON worldview(category);
CREATE INDEX idx_worldview_parent_id ON worldview(parent_id);
```

### 2.10 标签表 (tags)
```sql
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  work_id UUID REFERENCES works(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL,
  color VARCHAR(7), -- 十六进制颜色
  description TEXT,

  created_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(user_id, work_id, name)
);

CREATE INDEX idx_tags_user_id ON tags(user_id);
CREATE INDEX idx_tags_work_id ON tags(work_id);
```

### 2.11 章节标签关联表 (chapter_tags)
```sql
CREATE TABLE chapter_tags (
  chapter_id UUID NOT NULL REFERENCES chapters(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,

  position INTEGER, -- 在章节中的位置

  created_at TIMESTAMP DEFAULT NOW(),

  PRIMARY KEY(chapter_id, tag_id)
);

CREATE INDEX idx_chapter_tags_tag_id ON chapter_tags(tag_id);
```

---

## 3. AI 模块表设计

### 3.1 智能体表 (agents)
```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE, -- null 表示内置智能体

  -- 基本信息
  name VARCHAR(100) NOT NULL,
  description TEXT,
  avatar_url VARCHAR(500),

  -- 分类
  category VARCHAR(50) DEFAULT 'custom', -- builtin, custom, genre, task
  subcategory VARCHAR(100),

  -- 智能体配置
  system_prompt TEXT NOT NULL,
  behavior JSONB NOT NULL, -- 行为参数
  knowledge TEXT[], -- 知识领域
  examples TEXT[], -- 示例

  -- 模型偏好
  model_preference VARCHAR(100),

  -- 权限
  is_builtin BOOLEAN DEFAULT FALSE,
  is_public BOOLEAN DEFAULT FALSE,
  is_official BOOLEAN DEFAULT FALSE, -- 官方推荐

  -- 统计
  usage_count INTEGER DEFAULT 0,
  rating DECIMAL(2,1) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,

  -- 分享
  share_code VARCHAR(20) UNIQUE,
  shared_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_agents_user_id ON agents(user_id);
CREATE INDEX idx_agents_category ON agents(category);
CREATE INDEX idx_agents_is_public ON agents(is_public) WHERE is_public = TRUE;
CREATE INDEX idx_agents_is_builtin ON agents(is_builtin) WHERE is_builtin = TRUE;
CREATE INDEX idx_agents_share_code ON agents(share_code);
CREATE INDEX idx_agents_deleted_at ON agents(deleted_at) WHERE deleted_at IS NOT NULL;

-- 全文搜索
CREATE INDEX idx_agents_search ON agents USING GIN(to_tsvector('chinese', name || ' ' || COALESCE(description, '')));
```

### 3.2 AI 请求记录表 (ai_requests)
```sql
CREATE TABLE ai_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  work_id UUID REFERENCES works(id),
  chapter_id UUID REFERENCES chapters(id),

  -- 请求信息
  request_type VARCHAR(50) NOT NULL, -- continue, rewrite, generate, chat, analyze
  agent_id UUID REFERENCES agents(id),
  model_id VARCHAR(100) NOT NULL,

  -- 请求内容
  input_tokens INTEGER NOT NULL,
  input_text TEXT,
  context JSONB, -- 上下文信息

  -- 响应信息
  output_tokens INTEGER,
  output_text TEXT,
  is_streaming BOOLEAN DEFAULT TRUE,

  -- 状态
  status VARCHAR(50) DEFAULT 'completed', -- pending, processing, completed, failed, cancelled
  error_message TEXT,

  -- 成本
  cost DECIMAL(10,4), -- 实际成本

  -- 时间
  started_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  duration_ms INTEGER, -- 耗时（毫秒）

  -- 任务ID（WebSocket 关联）
  task_id UUID
);

-- 索引
CREATE INDEX idx_ai_requests_user_id ON ai_requests(user_id);
CREATE INDEX idx_ai_requests_work_id ON ai_requests(work_id);
CREATE INDEX idx_ai_requests_chapter_id ON ai_requests(chapter_id);
CREATE INDEX idx_ai_requests_agent_id ON ai_requests(agent_id);
CREATE INDEX idx_ai_requests_model_id ON ai_requests(model_id);
CREATE INDEX idx_ai_requests_status ON ai_requests(status);
CREATE INDEX idx_ai_requests_started_at ON ai_requests(started_at DESC);
CREATE INDEX idx_ai_requests_task_id ON ai_requests(task_id);

-- 分区（按月）
-- CREATE TABLE ai_requests_2026_02 PARTITION OF ai_requests
--   FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
```

### 3.3 AI 使用统计表 (ai_usage_stats)
```sql
CREATE TABLE ai_usage_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- 统计周期
  stat_date DATE NOT NULL,

  -- 统计数据
  total_requests INTEGER DEFAULT 0,
  total_input_tokens INTEGER DEFAULT 0,
  total_output_tokens INTEGER DEFAULT 0,
  total_cost DECIMAL(10,4) DEFAULT 0,

  -- 按模型统计
  by_model JSONB DEFAULT '{}'::jsonb,

  -- 按类型统计
  by_type JSONB DEFAULT '{}'::jsonb,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(user_id, stat_date)
);

CREATE INDEX idx_ai_usage_stats_user_id ON ai_usage_stats(user_id);
CREATE INDEX idx_ai_usage_stats_stat_date ON ai_usage_stats(stat_date DESC);
```

---

## 4. 系统表设计

### 4.1 LLM 模型配置表 (llm_models)
```sql
CREATE TABLE llm_models (
  id VARCHAR(100) PRIMARY KEY, -- 模型唯一标识
  name VARCHAR(255) NOT NULL,
  provider VARCHAR(50) NOT NULL, -- openai, anthropic, deepseek, local

  -- 模型信息
  context_window INTEGER NOT NULL,
  max_output_tokens INTEGER,

  -- 定价
  input_price DECIMAL(10,6), -- 每 1K tokens 价格
  output_price DECIMAL(10,6),

  -- 功能
  supports_streaming BOOLEAN DEFAULT TRUE,
  supports_function_calling BOOLEAN DEFAULT FALSE,

  -- 状态
  is_active BOOLEAN DEFAULT TRUE,
  is_free_tier BOOLEAN DEFAULT FALSE, -- 免费套餐可用

  -- 配置
  api_endpoint VARCHAR(500),
  config JSONB DEFAULT '{}'::jsonb,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_llm_models_provider ON llm_models(provider);
CREATE INDEX idx_llm_models_is_active ON llm_models(is_active);
```

### 4.2 文件表 (files)
```sql
CREATE TABLE files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- 文件信息
  filename VARCHAR(255) NOT NULL,
  original_filename VARCHAR(255),
  mime_type VARCHAR(100),
  file_size BIGINT NOT NULL,

  -- 存储信息
  storage_provider VARCHAR(50) DEFAULT 'local', -- local, s3, oss
  storage_path VARCHAR(500) NOT NULL,
  url VARCHAR(500),

  -- 关联
  entity_type VARCHAR(50), -- work, user, character
  entity_id UUID,

  -- 状态
  is_public BOOLEAN DEFAULT FALSE,
  expires_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_files_user_id ON files(user_id);
CREATE INDEX idx_files_entity ON files(entity_type, entity_id);
CREATE INDEX idx_files_expires_at ON files(expires_at) WHERE expires_at IS NOT NULL;
```

### 4.3 通知表 (notifications)
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- 通知内容
  type VARCHAR(50) NOT NULL, -- system, update, reminder
  title VARCHAR(255) NOT NULL,
  content TEXT,

  -- 链接
  link VARCHAR(500),
  link_type VARCHAR(50), -- work, chapter, agent

  -- 状态
  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

### 4.4 限流表 (rate_limits)
```sql
CREATE TABLE rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id), -- null 表示匿名用户

  -- 限流键
  rate_key VARCHAR(255) NOT NULL, -- ip:api_path 或 user_id:api_path

  -- 计数
  count INTEGER DEFAULT 0,
  window_start TIMESTAMP NOT NULL,

  -- 规则
  limit_per_window INTEGER NOT NULL,
  window_duration INTEGER NOT NULL, -- 秒

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(rate_key)
);

CREATE INDEX idx_rate_limits_rate_key ON rate_limits(rate_key);
CREATE INDEX idx_rate_limits_window_start ON rate_limits(window_start);
```

### 4.5 系统日志表 (system_logs)
```sql
CREATE TABLE system_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 日志信息
  level VARCHAR(20) NOT NULL, -- debug, info, warn, error
  message TEXT NOT NULL,
  context JSONB,

  -- 来源
  service VARCHAR(100),
  method VARCHAR(20),
  path VARCHAR(500),

  -- 用户
  user_id UUID REFERENCES users(id),

  -- 元数据
  ip_address VARCHAR(45),
  user_agent TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_system_logs_level ON system_logs(level);
CREATE INDEX idx_system_logs_user_id ON system_logs(user_id);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at DESC);

-- 定期清理：只保留最近 90 天
CREATE INDEX idx_system_logs_cleanup ON system_logs(created_at)
  WHERE created_at < (NOW() - INTERVAL '90 days');
```

### 4.6 系统配置表 (system_config)
```sql
CREATE TABLE system_config (
  key VARCHAR(100) PRIMARY KEY,
  value JSONB NOT NULL,
  description TEXT,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 预设配置
INSERT INTO system_config (key, value, description) VALUES
('ai.models.default', '"gpt-4-turbo"', '默认 AI 模型'),
('ai.models.available', '["gpt-4-turbo", "gpt-3.5-turbo", "claude-3-opus"]', '可用 AI 模型列表'),
('ai.rate_limit_per_minute', '20', 'AI 请求每分钟限制'),
('ai.free_tier_monthly_tokens', '100000', '免费套餐每月 token 限制'),
('storage.max_file_size', '10485760', '最大文件大小（字节）'),
('auth.jwt_expires_in', '7200', 'JWT 过期时间（秒）'),
('auth.refresh_token_expires_in', '604800', '刷新令牌过期时间（秒）');
```

---

## 5. 缓存设计 (Redis)

### 5.1 缓存键命名规范
```
{n}:{id}:{key}
```

- `n` - 命名空间: `user`, `work`, `chapter`, `agent`, `ai`
- `id` - 资源ID
- `key` - 具体键

### 5.2 缓存策略

| 数据类型 | 缓存键 | TTL | 策略 |
|---------|--------|-----|------|
| 用户信息 | `user:{id}` | 1 小时 | 懒加载 |
| 用户设置 | `user:{id}:settings` | 24 小时 | 懒加载 |
| 作品信息 | `work:{id}` | 1 小时 | 懒加载 |
| 章节内容 | `chapter:{id}` | 30 分钟 | 懒加载 |
| 智能体配置 | `agent:{id}` | 24 小时 | 懒加载 |
| LLM 响应 | `ai:{hash}` | 7 天 | 命中时更新 |
| 在线用户 | `online:{user_id}` | 5 分钟 | 主动更新 |

### 5.3 分布式锁
```
lock:{resource}:{id}
```

用于并发控制，如章节编辑锁、AI 生成任务锁。

### 5.4 消息队列（可选）
```
queue:{queue_name}
```

- `queue:ai_requests` - AI 请求队列
- `queue:email` - 邮件发送队列
- `queue:notifications` - 通知队列

---

## 6. 数据迁移与备份

### 6.1 迁移策略
- 使用 Drizzle Kit 迁移
- 版本控制所有迁移文件
- 支持回滚
- 迁移前自动备份
- 增量迁移支持

### 6.2 备份策略
- **数据库**: 每日全量备份 + 实时 WAL 归档
- **Redis**: RDB 每小时 + AOF 实时
- **文件存储**: 对象存储自带冗余

### 6.3 备份保留
- 每日备份保留 30 天
- 每周备份保留 12 周
- 每月备份保留 12 个月

---

## 7. 性能优化

### 7.1 索引优化
- 为所有外键创建索引
- 为常用查询条件创建复合索引
- 使用 GIN 索引加速 JSONB 和全文搜索

### 7.2 查询优化
- 使用 `EXPLAIN ANALYZE` 分析慢查询
- 避免 SELECT *
- 合理使用 JOIN
- 利用物化视图（未来）

### 7.3 分区策略
- `ai_requests` 按月分区
- `version_history` 按月分区
- `system_logs` 按月分区

### 7.4 读写分离（未来）
- 主库处理写操作
- 从库处理读操作
- 使用 pgBouncer 连接池

---

## 8. 数据清理策略

| 表 | 清理规则 | 保留期 |
|----|---------|--------|
| `version_history` | 定时任务 | 30 天 |
| `system_logs` | 定时任务 | 90 天 |
| `ai_requests` | 归档到存储 | 1 年 |
| `notifications` | 用户删除 | 30 天 |
| `rate_limits` | 自动过期 | 窗口期 |
| `files` (临时) | 自动过期 | 1 小时 |

---

## 9. 安全性

### 9.1 数据加密
- 密码使用 bcrypt 加密
- 敏感数据使用 AES 加密（可选）
- 传输层使用 TLS 1.3

### 9.2 访问控制
- 行级安全策略（RLS）
- 最小权限原则
- API 层认证 + 数据库层验证

### 9.3 审计日志
- 记录所有敏感操作
- 用户操作日志
- 管理员操作日志

---

## 10. 扩展性设计

### 10.1 多租户（未来）
```sql
ALTER TABLE users ADD COLUMN tenant_id UUID;
CREATE INDEX idx_users_tenant_id ON users(tenant_id);
```

### 10.2 国际化（未来）
```sql
CREATE TABLE translations (
  key VARCHAR(255) PRIMARY KEY,
  language VARCHAR(10) NOT NULL,
  value TEXT NOT NULL,
  UNIQUE(key, language)
);
```

### 10.3 协作功能（未来）
```sql
CREATE TABLE collaborators (
  work_id UUID REFERENCES works(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(50) NOT NULL, -- owner, editor, commenter
  permissions JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY(work_id, user_id)
);
```

---

**文档版本**: v1.0
**最后更新**: 2026-02-11
