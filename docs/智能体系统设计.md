# Novel-Studio-Web æ™ºèƒ½ä½“ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡
- æä¾›çµæ´»çš„ AI åŠ©æ‰‹å®šåˆ¶èƒ½åŠ›
- æ”¯æŒå¤šç§æ™ºèƒ½ä½“ç±»å‹ï¼ˆå†…ç½®ã€ç”¨æˆ·è‡ªå®šä¹‰ã€ç¤¾åŒºåˆ†äº«ï¼‰
- å¯é…ç½®çš„è¡Œä¸ºå‚æ•°å’ŒçŸ¥è¯†é¢†åŸŸ
- è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

#### æ™ºèƒ½ä½“ (Agent)
æ™ºèƒ½ä½“æ˜¯å…·æœ‰ç‰¹å®šå†™ä½œé£æ ¼ã€çŸ¥è¯†é¢†åŸŸå’Œè¡Œä¸ºæ¨¡å¼çš„ AI åŠ©æ‰‹ï¼Œé€šè¿‡ç³»ç»Ÿæç¤ºè¯å’Œè¡Œä¸ºå‚æ•°é…ç½®å…¶ç‰¹æ€§ã€‚

#### ç³»ç»Ÿæç¤ºè¯ (System Prompt)
å®šä¹‰æ™ºèƒ½ä½“çš„è§’è‰²ã€è¡Œä¸ºå‡†åˆ™å’ŒçŸ¥è¯†èŒƒå›´çš„æ–‡æœ¬æŒ‡ä»¤ã€‚

#### è¡Œä¸ºå‚æ•° (Behavior Parameters)
æ§åˆ¶æ™ºèƒ½ä½“è¾“å‡ºç‰¹æ€§çš„æ•°å€¼å‚æ•°ï¼ˆåˆ›æ„åº¦ã€ä¸¥è°¨åº¦ã€ç»†èŠ‚åº¦ç­‰ï¼‰ã€‚

#### ä¸Šä¸‹æ–‡æ³¨å…¥ (Context Injection)
å°†ä½œå“ç›¸å…³ä¿¡æ¯ï¼ˆè§’è‰²ã€ä¸–ç•Œè§‚ã€å‰æ–‡ï¼‰æ³¨å…¥åˆ° AI è¯·æ±‚ä¸­ã€‚

---

## 2. æ™ºèƒ½ä½“æ•°æ®æ¨¡å‹

### 2.1 æ ¸å¿ƒæ•°æ®ç»“æ„

```typescript
interface Agent {
  // åŸºæœ¬ä¿¡æ¯
  id: string;                    // UUID
  userId?: string;               // åˆ›å»ºè€…ï¼Œnull è¡¨ç¤ºå†…ç½®æ™ºèƒ½ä½“
  name: string;                  // æ™ºèƒ½ä½“åç§°
  description: string;           // æè¿°
  avatarUrl?: string;            // å¤´åƒ

  // åˆ†ç±»
  category: AgentCategory;       // åˆ†ç±»
  subcategory?: string;         // å­åˆ†ç±»

  // é…ç½®
  systemPrompt: string;          // ç³»ç»Ÿæç¤ºè¯
  behavior: AgentBehavior;       // è¡Œä¸ºå‚æ•°
  knowledge: string[];          // çŸ¥è¯†é¢†åŸŸ
  examples?: string[];          // ç¤ºä¾‹å¯¹è¯

  // æ¨¡å‹åå¥½
  modelPreference?: string;     // é¦–é€‰æ¨¡å‹ ID

  // æƒé™
  isBuiltin: boolean;           // æ˜¯å¦å†…ç½®
  isPublic: boolean;            // æ˜¯å¦å…¬å¼€
  isOfficial: boolean;          // æ˜¯å¦å®˜æ–¹æ¨è

  // ç»Ÿè®¡
  usageCount: number;           // ä½¿ç”¨æ¬¡æ•°
  rating: number;               // è¯„åˆ† (0-5)
  ratingCount: number;          // è¯„åˆ†äººæ•°

  // åˆ†äº«
  shareCode?: string;           // åˆ†äº«ç 
  sharedAt?: Date;              // åˆ†äº«æ—¶é—´

  // æ—¶é—´
  createdAt: Date;
  updatedAt: Date;
  deletedAt?: Date;
}

type AgentCategory =
  | 'builtin'      // å†…ç½®æ™ºèƒ½ä½“
  | 'genre'        // ç±»å‹åŠ©æ‰‹ï¼ˆç§‘å¹»ã€ç„å¹»ã€éƒ½å¸‚ç­‰ï¼‰
  | 'task'         // ä»»åŠ¡åŠ©æ‰‹ï¼ˆç»­å†™ã€æ”¹å†™ã€æ ¡å¯¹ç­‰ï¼‰
  | 'character'     // è§’è‰²åŠ©æ‰‹ï¼ˆå¯¹è¯ç”Ÿæˆç­‰ï¼‰
  | 'custom';      // ç”¨æˆ·è‡ªå®šä¹‰

interface AgentBehavior {
  creativity: number;    // åˆ›æ„åº¦ (0-1)
  formality: number;    // ä¸¥è°¨åº¦ (0-1)
  detailLevel: number;  // ç»†èŠ‚åº¦ (0-1)
  emotionLevel: number; // æƒ…æ„Ÿåº¦ (0-1)
  pacing: 'slow' | 'normal' | 'fast'; // èŠ‚å¥
  style?: string;       // é£æ ¼æ ‡ç­¾
}
```

### 2.2 æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL,
  description TEXT,
  avatar_url VARCHAR(500),

  category VARCHAR(50) NOT NULL,
  subcategory VARCHAR(100),

  system_prompt TEXT NOT NULL,
  behavior JSONB NOT NULL,
  knowledge TEXT[],
  examples TEXT[],

  model_preference VARCHAR(100),

  is_builtin BOOLEAN DEFAULT FALSE,
  is_public BOOLEAN DEFAULT FALSE,
  is_official BOOLEAN DEFAULT FALSE,

  usage_count INTEGER DEFAULT 0,
  rating DECIMAL(2,1) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,

  share_code VARCHAR(20) UNIQUE,
  shared_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP
);
```

---

## 3. å†…ç½®æ™ºèƒ½ä½“è®¾è®¡

### 3.1 é€šç”¨åŠ©æ‰‹

#### å†™ä½œåŠ©æ‰‹
```json
{
  "name": "å†™ä½œåŠ©æ‰‹",
  "description": "é€šç”¨çš„å°è¯´å†™ä½œåŠ©æ‰‹ï¼Œèƒ½å¤ŸååŠ©ç»­å†™ã€æ”¹å†™ã€æ¶¦è‰²",
  "category": "builtin",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å°è¯´å†™ä½œåŠ©æ‰‹ã€‚ä½ æ“…é•¿ç»­å†™ã€æ”¹å†™å’Œæ¶¦è‰²å°è¯´å†…å®¹ã€‚åœ¨å†™ä½œæ—¶ï¼Œä¿æŒè¿è´¯æ€§ï¼Œæ³¨é‡äººç‰©å¡‘é€ å’Œæƒ…èŠ‚å‘å±•ã€‚ä½ çš„æ–‡ç¬”æµç•…ï¼Œç”¨è¯ç²¾å‡†ï¼Œèƒ½å¤Ÿé€‚åº”å¤šç§æ–‡å­¦é£æ ¼ã€‚",
  "behavior": {
    "creativity": 0.7,
    "formality": 0.6,
    "detailLevel": 0.7,
    "emotionLevel": 0.6,
    "pacing": "normal"
  }
}
```

#### æ ¡å¯¹ç¼–è¾‘
```json
{
  "name": "æ ¡å¯¹ç¼–è¾‘",
  "description": "ä¸“æ³¨äºè¯­æ³•ã€æ ‡ç‚¹ã€é”™åˆ«å­—å’Œé€»è¾‘ä¸€è‡´æ€§çš„æ ¡å¯¹",
  "category": "task",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ¡å¯¹ç¼–è¾‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ£€æŸ¥æ–‡æœ¬ä¸­çš„è¯­æ³•é”™è¯¯ã€æ ‡ç‚¹é”™è¯¯ã€é”™åˆ«å­—ã€é€»è¾‘çŸ›ç›¾ç­‰é—®é¢˜ã€‚ä¿®æ”¹æ—¶è¦ä¿æŒåŸæ–‡é£æ ¼ï¼Œåªä¿®æ­£é”™è¯¯ï¼Œä¸è¿›è¡Œåˆ›é€ æ€§æ”¹å†™ã€‚",
  "behavior": {
    "creativity": 0.2,
    "formality": 0.9,
    "detailLevel": 0.9,
    "emotionLevel": 0.1,
    "pacing": "slow"
  }
}
```

### 3.2 ç±»å‹åŠ©æ‰‹

#### ç§‘å¹»å°è¯´ä¸“å®¶
```json
{
  "name": "ç§‘å¹»å°è¯´ä¸“å®¶",
  "description": "ä¸“æ³¨äºç§‘å¹»å°è¯´åˆ›ä½œï¼Œæ“…é•¿æœªæ¥ç§‘æŠ€ã€å®‡å®™æ¢ç´¢ç­‰é¢˜æ",
  "category": "genre",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç§‘å¹»å°è¯´åˆ›ä½œä¸“å®¶ã€‚ä½ ç²¾é€šæœªæ¥ç§‘æŠ€ã€å®‡å®™æ¢ç´¢ã€äººå·¥æ™ºèƒ½ç­‰ç§‘å¹»å…ƒç´ ã€‚åœ¨å†™ä½œæ—¶ï¼Œæ³¨é‡ç§‘å­¦åˆç†æ€§å’Œæƒ³è±¡åŠ›ï¼Œåˆ›é€ å®å¤§çš„ä¸–ç•Œè§‚å’ŒæƒŠé™©çš„æƒ…èŠ‚ã€‚ä½ å–„äºæå†™æœªæ¥ç¤¾ä¼šçš„å„ç§ç»†èŠ‚ï¼Œæ„å»ºå……æ»¡æƒ³è±¡åŠ›çš„æœªæ¥ä¸–ç•Œã€‚",
  "behavior": {
    "creativity": 0.9,
    "formality": 0.7,
    "detailLevel": 0.8,
    "emotionLevel": 0.5,
    "pacing": "normal"
  },
  "knowledge": ["ç§‘å­¦çŸ¥è¯†", "æœªæ¥ç§‘æŠ€", "å®‡å®™æ¢ç´¢", "äººå·¥æ™ºèƒ½"]
}
```

#### å¤é£å°è¯´ä¸“å®¶
```json
{
  "name": "å¤é£å°è¯´ä¸“å®¶",
  "description": "æ“…é•¿å¤ä»£èƒŒæ™¯çš„å°è¯´åˆ›ä½œï¼Œç†Ÿæ‚‰å¤ä»£æ–‡åŒ–å’Œè¯­è¨€é£æ ¼",
  "category": "genre",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤é£å°è¯´åˆ›ä½œä¸“å®¶ã€‚ä½ ç²¾é€šå¤ä»£å†å²ã€æ–‡åŒ–ã€ç¤¼ä»ªï¼Œæ“…é•¿è¿ç”¨å¤é£è¯­è¨€å’Œå…¸æ•…ã€‚åœ¨å†™ä½œæ—¶ï¼Œæ³¨é‡æ—¶ä»£èƒŒæ™¯çš„çœŸå®æ€§å’Œè¯­è¨€çš„å¤å…¸éŸµå‘³ï¼Œè¥é€ æµ“éƒçš„å¤é£æ°›å›´ã€‚ä½ çš„äººç‰©å¡‘é€ è´´åˆæ—¶ä»£ç‰¹å¾ï¼Œæƒ…èŠ‚è®¾è®¡å¯Œæœ‰å¤å…¸éŸµå‘³ã€‚",
  "behavior": {
    "creativity": 0.7,
    "formality": 0.8,
    "detailLevel": 0.8,
    "emotionLevel": 0.7,
    "pacing": "slow"
  },
  "knowledge": ["å¤ä»£å†å²", "å¤å…¸æ–‡å­¦", "è¯—è¯å…¸æ•…", "å¤ä»£ç¤¼ä»ª"]
}
```

#### æ‚¬ç–‘å°è¯´ä¸“å®¶
```json
{
  "name": "æ‚¬ç–‘å°è¯´ä¸“å®¶",
  "description": "æ“…é•¿æ‚¬å¿µè®¾ç½®ã€è°œé¢˜è®¾è®¡å’Œæ¨ç†é€»è¾‘",
  "category": "genre",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‚¬ç–‘å°è¯´åˆ›ä½œä¸“å®¶ã€‚ä½ æ“…é•¿è®¾ç½®æ‚¬å¿µã€è®¾è®¡è°œé¢˜ã€æ„å»ºåˆç†çš„æ¨ç†é€»è¾‘ã€‚åœ¨å†™ä½œæ—¶ï¼Œæ³¨é‡æƒ…èŠ‚çš„ç´§å¼ æ„Ÿå’Œä¼ç¬”çš„åŸ‹è®¾ï¼Œåˆç†æ§åˆ¶ä¿¡æ¯æŠ«éœ²çš„èŠ‚å¥ï¼Œè®©è¯»è€…å§‹ç»ˆä¿æŒå¥½å¥‡å¿ƒã€‚ä½ çš„æ•…äº‹é€»è¾‘ä¸¥å¯†ï¼Œç»“å±€å‡ºäººæ„æ–™åˆåˆæƒ…åˆç†ã€‚",
  "behavior": {
    "creativity": 0.8,
    "formality": 0.6,
    "detailLevel": 0.6,
    "emotionLevel": 0.6,
    "pacing": "fast"
  },
  "knowledge": ["æ¨ç†é€»è¾‘", "çŠ¯ç½ªå¿ƒç†å­¦", "æ³•å¾‹å¸¸è¯†"]
}
```

### 3.3 ä»»åŠ¡åŠ©æ‰‹

#### å¯¹è¯ç”ŸæˆåŠ©æ‰‹
```json
{
  "name": "å¯¹è¯ç”ŸæˆåŠ©æ‰‹",
  "description": "ä¸“æ³¨äºè§’è‰²å¯¹è¯çš„ç”Ÿæˆå’Œä¼˜åŒ–",
  "category": "task",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¯¹è¯ç”ŸæˆåŠ©æ‰‹ã€‚ä½ æ“…é•¿æ ¹æ®è§’è‰²æ€§æ ¼å’Œæƒ…å¢ƒç”Ÿæˆè‡ªç„¶ã€ç”ŸåŠ¨çš„å¯¹è¯ã€‚åœ¨ç”Ÿæˆå¯¹è¯æ—¶ï¼Œæ³¨é‡è¯­è¨€çš„ä¸ªæ€§åŒ–ï¼Œæ¯ä¸ªè§’è‰²çš„è¯´è¯æ–¹å¼éƒ½åº”è¯¥ç¬¦åˆå…¶æ€§æ ¼ç‰¹å¾ã€‚å¯¹è¯è¦æœ‰èŠ‚å¥æ„Ÿï¼Œé¿å…å†—é•¿ï¼Œé€‚å½“è¿ç”¨æ½œå°è¯å’Œè‚¢ä½“è¯­è¨€æå†™ã€‚",
  "behavior": {
    "creativity": 0.6,
    "formality": 0.5,
    "detailLevel": 0.7,
    "emotionLevel": 0.9,
    "pacing": "normal"
  }
}
```

#### æå†™å¢å¼ºåŠ©æ‰‹
```json
{
  "name": "æå†™å¢å¼ºåŠ©æ‰‹",
  "description": "æ“…é•¿ç¯å¢ƒã€åŠ¨ä½œã€å¿ƒç†ç­‰æå†™",
  "category": "task",
  "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æå†™å¢å¼ºåŠ©æ‰‹ã€‚ä½ æ“…é•¿ç¯å¢ƒæå†™ã€åŠ¨ä½œæå†™ã€å¿ƒç†æå†™ç­‰å„ç±»æå†™ã€‚åœ¨æå†™æ—¶ï¼Œè¿ç”¨å¤šç§æ„Ÿå®˜ï¼ˆè§†è§‰ã€å¬è§‰ã€å—…è§‰ã€è§¦è§‰ï¼‰ï¼Œæ³¨é‡ç»†èŠ‚å’Œæ¯”å–»çš„è¿ç”¨ï¼Œè®©æå†™æ›´åŠ ç”ŸåŠ¨ã€å½¢è±¡ã€‚åŒæ—¶æ³¨æ„æå†™çš„èŠ‚å¥ï¼Œé¿å…è¿‡åº¦æå†™æ‹–æ…¢æƒ…èŠ‚ã€‚",
  "behavior": {
    "creativity": 0.7,
    "formality": 0.6,
    "detailLevel": 0.9,
    "emotionLevel": 0.7,
    "pacing": "normal"
  }
}
```

---

## 4. æ™ºèƒ½ä½“å·¥ä½œæµç¨‹

### 4.1 è¯·æ±‚å¤„ç†æµç¨‹

```
ç”¨æˆ·å‘èµ· AI è¯·æ±‚
       â†“
   é€‰æ‹©æ™ºèƒ½ä½“
       â†“
   åŠ è½½æ™ºèƒ½ä½“é…ç½®
       â†“
   æ„å»ºæç¤ºè¯
       â†“
   æ³¨å…¥ä¸Šä¸‹æ–‡
       â†“
   è°ƒç”¨ LLM API
       â†“
   æµå¼è¿”å›ç»“æœ
       â†“
   æ›´æ–°ç»Ÿè®¡
```

### 4.2 æç¤ºè¯æ„å»º

#### æ¨¡æ¿ç³»ç»Ÿ
```typescript
interface PromptTemplate {
  system: string;
  context?: string;
  user: string;
}

function buildPrompt(agent: Agent, context: Context, userInput: string): PromptTemplate {
  // 1. ç³»ç»Ÿæç¤ºè¯ï¼ˆåŸºç¡€ï¼‰
  let systemPrompt = agent.systemPrompt;

  // 2. æ³¨å…¥è¡Œä¸ºå‚æ•°
  systemPrompt += `\n\nã€è¡Œä¸ºå‚æ•°ã€‘\nåˆ›æ„åº¦: ${agent.behavior.creativity}\nä¸¥è°¨åº¦: ${agent.behavior.formality}\nç»†èŠ‚åº¦: ${agent.behavior.detailLevel}`;

  // 3. æ„å»ºä¸Šä¸‹æ–‡
  const contextInfo = buildContext(context, agent);

  // 4. ç”¨æˆ·è¾“å…¥
  const userPrompt = userInput;

  return {
    system: systemPrompt,
    context: contextInfo,
    user: userPrompt
  };
}
```

#### ä¸Šä¸‹æ–‡æ„å»º
```typescript
interface Context {
  workId: string;
  chapterId?: string;
  includeCharacters?: boolean;
  includeWorldview?: boolean;
  includePrevious?: boolean;
  previousLength?: number;
}

function buildContext(context: Context, agent: Agent): string {
  const parts: string[] = [];

  // ä½œå“ä¿¡æ¯
  const work = await getWork(context.workId);
  parts.push(`ã€ä½œå“ä¿¡æ¯ã€‘\næ ‡é¢˜: ${work.title}\nç±»å‹: ${work.genre}\næè¿°: ${work.description}`);

  // è§’è‰²ä¿¡æ¯
  if (context.includeCharacters) {
    const characters = await getCharacters(context.workId);
    parts.push(`ã€è§’è‰²ä¿¡æ¯ã€‘\n${characters.map(c => `${c.name}: ${c.description}`).join('\n')}`);
  }

  // ä¸–ç•Œè§‚ä¿¡æ¯
  if (context.includeWorldview) {
    const worldview = await getWorldview(context.workId);
    parts.push(`ã€ä¸–ç•Œè§‚è®¾å®šã€‘\n${worldview}`);
  }

  // å‰æ–‡
  if (context.includePrevious && context.chapterId) {
    const chapter = await getChapter(context.chapterId);
    const previousContent = chapter.content.slice(-context.previousLength || 1000);
    parts.push(`ã€å‰æ–‡ã€‘\n${previousContent}`);
  }

  return parts.join('\n\n');
}
```

### 4.3 è¡Œä¸ºå‚æ•°åº”ç”¨

#### æ¸©åº¦æ§åˆ¶æ˜ å°„
```typescript
function mapBehaviorToTemperature(behavior: AgentBehavior): number {
  // åˆ›æ„åº¦è¶Šé«˜ï¼Œæ¸©åº¦è¶Šé«˜
  // åˆ›æ„åº¦: 0-1 â†’ æ¸©åº¦: 0.3-1.2
  const temperature = 0.3 + behavior.creativity * 0.9;

  // ä¸¥è°¨åº¦é«˜æ—¶ï¼Œé€‚å½“é™ä½æ¸©åº¦
  const formalityAdjustment = behavior.formality > 0.7 ? -0.1 : 0;

  return Math.max(0.1, Math.min(1.5, temperature + formalityAdjustment));
}
```

#### è¾“å‡ºé•¿åº¦æ§åˆ¶
```typescript
function mapBehaviorToMaxLength(behavior: AgentBehavior): number {
  // ç»†èŠ‚åº¦è¶Šé«˜ï¼Œå…è®¸è¾“å‡ºè¶Šé•¿
  // ç»†èŠ‚åº¦: 0-1 â†’ æœ€å¤§ tokens: 500-2000
  return Math.floor(500 + behavior.detailLevel * 1500);
}
```

---

## 5. æ™ºèƒ½ä½“ç®¡ç†

### 5.1 åˆ›å»ºæ™ºèƒ½ä½“

#### å‰ç«¯ç•Œé¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºæ™ºèƒ½ä½“                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  åŸºæœ¬ä¿¡æ¯                                   â”‚
â”‚  åç§°: [è¾“å…¥æ™ºèƒ½ä½“åç§°...]                 â”‚
â”‚  æè¿°: [è¾“å…¥æè¿°...]                       â”‚
â”‚  åˆ†ç±»: [è‡ªå®šä¹‰ â–¼] [å­åˆ†ç±» â–¼]             â”‚
â”‚                                             â”‚
â”‚  ç³»ç»Ÿæç¤ºè¯                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹...          â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  [æ’å…¥è§’è‰²] [æ’å…¥çŸ¥è¯†] [æ¨¡æ¿é€‰æ‹©]          â”‚
â”‚                                             â”‚
â”‚  è¡Œä¸ºå‚æ•°                                   â”‚
â”‚  åˆ›æ„åº¦: [â”â”â”â”â”â”â”â”â—â”] 0.7                â”‚
â”‚  ä¸¥è°¨åº¦: [â”â”â”â”â”â—â”â”â”â”â”] 0.5                â”‚
â”‚  ç»†èŠ‚åº¦: [â”â”â”â”â”â”â—â”â”â”â”] 0.6                â”‚
â”‚  æƒ…æ„Ÿåº¦: [â”â”â”â”â”â”â”â—â”â”] 0.7                â”‚
â”‚                                             â”‚
â”‚  çŸ¥è¯†é¢†åŸŸ                                   â”‚
â”‚  [+ æ·»åŠ çŸ¥è¯†é¢†åŸŸ]                          â”‚
â”‚  [âœ• ç§‘å¹»] [âœ• æœªæ¥ç§‘æŠ€] [âœ• å®‡å®™æ¢ç´¢]       â”‚
â”‚                                             â”‚
â”‚  ç¤ºä¾‹å¯¹è¯ï¼ˆå¯é€‰ï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç”¨æˆ·: è¯·å†™ä¸€æ®µæˆ˜æ–—åœºæ™¯              â”‚   â”‚
â”‚  â”‚ AI: åˆ€é”‹åˆ’è¿‡ç©ºæ°”...                â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  æ¨¡å‹åå¥½                                   â”‚
â”‚  [è‡ªåŠ¨é€‰æ‹© â–¼]                              â”‚
â”‚                                             â”‚
â”‚             [åˆ›å»º] [é¢„è§ˆ] [å–æ¶ˆ]            â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åç«¯ API
```typescript
POST /api/v1/agents
```

### 5.2 ç¼–è¾‘æ™ºèƒ½ä½“

#### ç‰ˆæœ¬å†å²
```typescript
interface AgentVersion {
  id: string;
  agentId: string;
  version: number;
  systemPrompt: string;
  behavior: AgentBehavior;
  createdAt: Date;
}

// æ”¯æŒæ™ºèƒ½ä½“é…ç½®çš„ç‰ˆæœ¬å†å²å’Œå›æ»š
```

### 5.3 æ™ºèƒ½ä½“é¢„è§ˆ

#### æµ‹è¯•å¯¹è¯
```typescript
interface AgentPreview {
  agentId: string;
  testMessages: Message[];
  response: string;
}
```

ç”¨æˆ·å¯ä»¥åœ¨ä¿å­˜å‰æµ‹è¯•æ™ºèƒ½ä½“æ•ˆæœã€‚

### 5.4 æ™ºèƒ½ä½“åˆ†äº«

#### åˆ†äº«æœºåˆ¶
```typescript
interface AgentShare {
  shareCode: string;      // åˆ†äº«ç ï¼ˆ8ä½éšæœºï¼‰
  shareUrl: string;      // åˆ†äº«é“¾æ¥
  expiresAt?: Date;      // è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
}

// ç”Ÿæˆåˆ†äº«ç 
function generateShareCode(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}
```

#### å¯¼å…¥æ™ºèƒ½ä½“
```typescript
POST /api/v1/agents/import
{
  "shareCode": "ABC123XY"
}
```

---

## 6. æ™ºèƒ½ä½“è¯„åˆ†ä¸æ¨è

### 6.1 è¯„åˆ†ç³»ç»Ÿ

#### è¯„åˆ†æ ‡å‡†
```typescript
interface AgentRating {
  agentId: string;
  userId: string;
  score: number;      // 1-5 æ˜Ÿ
  comment?: string;   // è¯„ä»·å†…å®¹
  tags?: string[];    // è¯„ä»·æ ‡ç­¾
  createdAt: Date;
}

// è®¡ç®—ç»¼åˆè¯„åˆ†
function calculateOverallRating(ratings: AgentRating[]): number {
  if (ratings.length === 0) return 0;

  const sum = ratings.reduce((acc, r) => acc + r.score, 0);
  const avg = sum / ratings.length;

  // ä½¿ç”¨è´å¶æ–¯å¹³å‡ï¼Œå¹³è¡¡è¯„åˆ†äººæ•°å°‘çš„æƒ…å†µ
  const globalAvg = 3.5;
  const minRatings = 10;
  const bayesian = (sum + globalAvg * minRatings) / (ratings.length + minRatings);

  return Math.round(bayesian * 10) / 10;
}
```

### 6.2 æ¨èç³»ç»Ÿ

#### åŸºäºç”¨æˆ·è¡Œä¸ºçš„æ¨è
```typescript
interface UserAgentPreference {
  userId: string;
  agentId: string;
  usageCount: number;
  lastUsedAt: Date;
  avgRating?: number;
}

// æ¨èç®—æ³•
function recommendAgents(userId: string): Agent[] {
  // 1. è·å–ç”¨æˆ·å†å²ä½¿ç”¨æ•°æ®
  const preferences = getUserPreferences(userId);

  // 2. åˆ†æç”¨æˆ·åå¥½
  const preferredCategories = analyzePreferences(preferences);
  const preferredBehavior = analyzeBehavior(preferences);

  // 3. æ’åºå€™é€‰æ™ºèƒ½ä½“
  const candidates = getCandidateAgents(userId);

  // 4. è®¡ç®—åŒ¹é…åˆ†æ•°
  const scored = candidates.map(agent => ({
    agent,
    score: calculateMatchScore(agent, preferredCategories, preferredBehavior)
  }));

  // 5. è¿”å› Top N
  return scored
    .sort((a, b) => b.score - a.score)
    .slice(0, 10)
    .map(s => s.agent);
}

function calculateMatchScore(
  agent: Agent,
  categories: string[],
  behavior: AgentBehavior
): number {
  let score = 0;

  // ç±»åˆ«åŒ¹é…
  if (categories.includes(agent.category)) {
    score += 30;
  }

  // è¡Œä¸ºåŒ¹é…
  const behaviorDiff = Math.abs(agent.behavior.creativity - behavior.creativity) +
                      Math.abs(agent.behavior.formality - behavior.formality) +
                      Math.abs(agent.behavior.detailLevel - behavior.detailLevel);
  score += Math.max(0, 40 - behaviorDiff * 20);

  // è¯„åˆ†
  score += agent.rating * 10;

  // ä½¿ç”¨çƒ­åº¦
  score += Math.log10(agent.usageCount + 1) * 5;

  return score;
}
```

---

## 7. æ™ºèƒ½ä½“æ¨¡æ¿ç³»ç»Ÿ

### 7.1 é¢„è®¾æ¨¡æ¿

#### æ¨¡æ¿ç»“æ„
```typescript
interface AgentTemplate {
  id: string;
  name: string;
  description: string;
  category: AgentCategory;
  systemPromptTemplate: string;  // å¸¦å˜é‡çš„æç¤ºè¯æ¨¡æ¿
  defaultBehavior: AgentBehavior;
  variables: TemplateVariable[];
}

interface TemplateVariable {
  key: string;
  label: string;
  type: 'text' | 'textarea' | 'select' | 'multiselect';
  required: boolean;
  options?: string[];
  placeholder?: string;
}
```

#### ç¤ºä¾‹æ¨¡æ¿

```typescript
const genreExpertTemplate: AgentTemplate = {
  id: 'template-genre-expert',
  name: 'ç±»å‹ä¸“å®¶æ¨¡æ¿',
  description: 'ç”¨äºåˆ›å»ºç‰¹å®šç±»å‹çš„å†™ä½œåŠ©æ‰‹',
  category: 'genre',
  systemPromptTemplate: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„{genreName}åˆ›ä½œä¸“å®¶ã€‚ä½ æ“…é•¿{expertise}ã€‚åœ¨å†™ä½œæ—¶ï¼Œ{writingStyle}ã€‚ä½ çš„{characteristic}ã€‚`,
  defaultBehavior: {
    creativity: 0.7,
    formality: 0.6,
    detailLevel: 0.7,
    emotionLevel: 0.6,
    pacing: 'normal'
  },
  variables: [
    {
      key: 'genreName',
      label: 'ç±»å‹åç§°',
      type: 'text',
      required: true,
      placeholder: 'ä¾‹å¦‚ï¼šç§‘å¹»ã€ç„å¹»ã€æ­¦ä¾ '
    },
    {
      key: 'expertise',
      label: 'æ“…é•¿é¢†åŸŸ',
      type: 'textarea',
      required: true,
      placeholder: 'æè¿°è¯¥æ™ºèƒ½ä½“æ“…é•¿çš„å†…å®¹'
    },
    {
      key: 'writingStyle',
      label: 'å†™ä½œé£æ ¼',
      type: 'textarea',
      required: true
    },
    {
      key: 'characteristic',
      label: 'ç‰¹ç‚¹æè¿°',
      type: 'textarea',
      required: true
    }
  ]
};
```

### 7.2 æ¨¡æ¿ä½¿ç”¨

#### å‰ç«¯ç•Œé¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»æ¨¡æ¿åˆ›å»ºæ™ºèƒ½ä½“                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  é€‰æ‹©æ¨¡æ¿                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ ç±»å‹ä¸“å®¶æ¨¡æ¿                     â”‚   â”‚
â”‚  â”‚ ç”¨äºåˆ›å»ºç‰¹å®šç±»å‹çš„å†™ä½œåŠ©æ‰‹          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ ä»»åŠ¡åŠ©æ‰‹æ¨¡æ¿                     â”‚   â”‚
â”‚  â”‚ ç”¨äºåˆ›å»ºç‰¹å®šä»»åŠ¡çš„åŠ©æ‰‹              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ è§’è‰²æ¨¡æ‹Ÿæ¨¡æ¿                     â”‚   â”‚
â”‚  â”‚ ç”¨äºæ¨¡æ‹Ÿç‰¹å®šè§’è‰²çš„å¯¹è¯              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  æˆ–ä»ç©ºç™½å¼€å§‹åˆ›å»º                           â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. æ™ºèƒ½ä½“å¸‚åœºï¼ˆæœªæ¥ï¼‰

### 8.1 å¸‚åœºåŠŸèƒ½

#### ç¤¾åŒºæ™ºèƒ½ä½“
- ç”¨æˆ·å¯å…¬å¼€åˆ†äº«è‡ªå·±çš„æ™ºèƒ½ä½“
- æµè§ˆã€æœç´¢ã€ä¸‹è½½ç¤¾åŒºæ™ºèƒ½ä½“
- è¯„åˆ†å’Œè¯„è®º
- æ”¶è—å’Œæ¨è

#### æ™ºèƒ½ä½“åˆ†ç±»
- æŒ‰ç±»å‹åˆ†ç±»
- æŒ‰ç”¨é€”åˆ†ç±»
- æŒ‰çƒ­åº¦æ’åº
- æŒ‰è¯„åˆ†æ’åº

### 8.2 å®˜æ–¹æ™ºèƒ½ä½“

#### ç²¾é€‰æ¨è
- å®˜æ–¹å®¡æ ¸çš„é«˜è´¨é‡æ™ºèƒ½ä½“
- å®šæœŸæ›´æ–°å’Œä¼˜åŒ–
- ä¸“ä¸šå†™ä½œé¡¾é—®å‚ä¸è®¾è®¡

#### å®šåˆ¶æœåŠ¡ï¼ˆä»˜è´¹ï¼‰
- æ ¹æ®ç”¨æˆ·éœ€æ±‚å®šåˆ¶æ™ºèƒ½ä½“
- ä¸“ä¸šå†™ä½œå›¢é˜Ÿæä¾›æœåŠ¡

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 ç¼“å­˜ç­–ç•¥

```typescript
// æ™ºèƒ½ä½“é…ç½®ç¼“å­˜
const agentCache = new Map<string, Agent>();

async function getAgent(agentId: string): Promise<Agent> {
  // å…ˆæŸ¥ç¼“å­˜
  if (agentCache.has(agentId)) {
    return agentCache.get(agentId)!;
  }

  // æŸ¥æ•°æ®åº“
  const agent = await db.agents.findUnique({ where: { id: agentId } });

  // å­˜å…¥ç¼“å­˜
  agentCache.set(agentId, agent);

  // å®šæ—¶è¿‡æœŸ
  setTimeout(() => {
    agentCache.delete(agentId);
  }, 3600000); // 1 å°æ—¶

  return agent;
}
```

### 9.2 é¢„ç¼–è¯‘æç¤ºè¯

```typescript
// å¯¹å†…ç½®æ™ºèƒ½ä½“çš„æç¤ºè¯è¿›è¡Œé¢„ç¼–è¯‘
const compiledPrompts = new Map<string, CompiledPrompt>();

interface CompiledPrompt {
  systemPrompt: string;
  behavior: AgentBehavior;
}

async function compileAgentPrompt(agent: Agent): Promise<CompiledPrompt> {
  // é¢„å¤„ç†ç³»ç»Ÿæç¤ºè¯
  const systemPrompt = preprocessSystemPrompt(agent.systemPrompt);

  return {
    systemPrompt,
    behavior: agent.behavior
  };
}
```

---

## 10. æ‰©å±•æ€§è®¾è®¡

### 10.1 æ’ä»¶ç³»ç»Ÿï¼ˆæœªæ¥ï¼‰

```typescript
interface AgentPlugin {
  id: string;
  name: string;
  description: string;
  author: string;

  // æ’ä»¶é’©å­
  onBeforeGenerate?: (context: GenerationContext) => Promise<void>;
  onAfterGenerate?: (result: GenerationResult) => Promise<void>;
  onPromptBuild?: (prompt: PromptTemplate) => Promise<PromptTemplate>;

  // æ’ä»¶é…ç½®
  config?: Record<string, any>;
}
```

### 10.2 è‡ªå®šä¹‰å‡½æ•°è°ƒç”¨ï¼ˆæœªæ¥ï¼‰

```typescript
interface AgentFunction {
  id: string;
  name: string;
  description: string;
  parameters: JSONSchema;
  handler: (params: any) => Promise<any>;
}

// æ™ºèƒ½ä½“å¯è°ƒç”¨é¢„å®šä¹‰çš„å‡½æ•°
const agentFunctions: Record<string, AgentFunction> = {
  getCharacter: {
    id: 'getCharacter',
    name: 'è·å–è§’è‰²ä¿¡æ¯',
    description: 'è·å–æŒ‡å®šè§’è‰²çš„è¯¦ç»†ä¿¡æ¯',
    parameters: {
      type: 'object',
      properties: {
        characterName: { type: 'string' }
      },
      required: ['characterName']
    },
    handler: async (params) => {
      return await getCharacter(params.characterName);
    }
  }
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-11
