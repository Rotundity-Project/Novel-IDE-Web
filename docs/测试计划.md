# Novel-Studio-Web 测试计划文档

## 1. 测试概述

### 1.1 测试目标
- 确保系统功能符合需求
- 保证代码质量和稳定性
- 发现并修复潜在问题
- 验证性能和安全要求

### 1.2 测试范围
- 单元测试
- 集成测试
- 端到端测试
- 性能测试
- 安全测试
- 用户验收测试

---

## 2. 测试环境

### 2.1 环境配置

| 环境 | 用途 | 数据库 | URL |
|------|------|--------|-----|
| Local | 开发测试 | SQLite/PostgreSQL | http://localhost:3000 |
| Test | 自动化测试 | PostgreSQL | http://test.novel-studio-web.com |
| Staging | 预发布测试 | PostgreSQL | http://staging.novel-studio-web.com |
| Production | 生产环境 | PostgreSQL | https://novel-studio-web.com |

### 2.2 测试数据

```typescript
// 测试数据种子
export const testUsers = [
  { id: '1', email: 'test@example.com', username: 'testuser', password: 'Test123!' },
];

export const testWorks = [
  { id: '1', title: '测试小说', description: '这是一个测试作品', userId: '1' },
];

export const testChapters = [
  { id: '1', title: '第一章', content: '这是第一章的内容...', workId: '1' },
];
```

---

## 3. 单元测试

### 3.1 前端单元测试

#### 技术栈
- **测试框架**: Vitest
- **测试工具**: React Testing Library
- **Mock 工具**: MSW (Mock Service Worker)
- **覆盖率**: c8

#### 测试配置 (`vitest.config.ts`)
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
    coverage: {
      provider: 'c8',
      reporter: ['text', 'json', 'html'],
      lines: 70,
      functions: 70,
      branches: 70,
      statements: 70,
    },
  },
});
```

#### 组件测试示例

```typescript
// Editor.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { Editor } from './Editor';

describe('Editor', () => {
  it('should render editor with initial content', () => {
    render(<Editor content="初始内容" onSave={() => {}} />);

    expect(screen.getByText('初始内容')).toBeInTheDocument();
  });

  it('should call onSave when save button is clicked', () => {
    const handleSave = vi.fn();
    render(<Editor content="测试内容" onSave={handleSave} />);

    const saveButton = screen.getByRole('button', { name: /保存/i });
    fireEvent.click(saveButton);

    expect(handleSave).toHaveBeenCalledWith('测试内容');
  });

  it('should update content when user types', () => {
    render(<Editor content="" onSave={() => {}} />);

    const textarea = screen.getByRole('textbox');
    fireEvent.change(textarea, { target: { value: '新内容' } });

    expect(textarea).toHaveValue('新内容');
  });
});
```

#### Hook 测试示例

```typescript
// useUser.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { useUser } from './useUser';

describe('useUser', () => {
  it('should fetch user data', async () => {
    const { result } = renderHook(() => useUser('1'));

    await waitFor(() => {
      expect(result.current.user).toBeDefined();
      expect(result.current.user?.id).toBe('1');
    });
  });

  it('should handle error when user not found', async () => {
    const { result } = renderHook(() => useUser('999'));

    await waitFor(() => {
      expect(result.current.error).toBeDefined();
    });
  });
});
```

#### 工具函数测试示例

```typescript
// utils/string.test.ts
import { describe, it, expect } from 'vitest';
import { countWords, slugify } from './string';

describe('countWords', () => {
  it('should count Chinese characters', () => {
    expect(countWords('你好世界')).toBe(4);
  });

  it('should count English words', () => {
    expect(countWords('Hello world')).toBe(2);
  });

  it('should count mixed content', () => {
    expect(countWords('Hello 你好')).toBe(3);
  });

  it('should ignore Markdown syntax', () => {
    expect(countWords('# 标题')).toBe(2);
    expect(countWords('[链接](http://example.com)')).toBe(2);
  });
});

describe('slugify', () => {
  it('should convert to slug', () => {
    expect(slugify('Hello World')).toBe('hello-world');
    expect(slugify('你好世界')).toBe('你好世界');
  });

  it('should remove special characters', () => {
    expect(slugify('Hello@World!')).toBe('hello-world');
  });
});
```

### 3.2 后端单元测试

#### 测试配置 (`vitest.config.ts`)
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'c8',
      include: ['src/**/*.ts'],
      exclude: ['src/test/**/*.ts'],
    },
  },
});
```

#### 服务层测试示例

```typescript
// services/auth.service.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { AuthService } from './auth.service';

describe('AuthService', () => {
  let authService: AuthService;

  beforeEach(() => {
    authService = new AuthService();
  });

  describe('login', () => {
    it('should return tokens for valid credentials', async () => {
      const result = await authService.login('test@example.com', 'Test123!');

      expect(result.tokens.accessToken).toBeDefined();
      expect(result.tokens.refreshToken).toBeDefined();
    });

    it('should throw error for invalid credentials', async () => {
      await expect(
        authService.login('test@example.com', 'wrong-password')
      ).rejects.toThrow('Invalid credentials');
    });
  });

  describe('register', () => {
    it('should create new user', async () => {
      const result = await authService.register({
        email: 'new@example.com',
        username: 'newuser',
        password: 'Test123!',
      });

      expect(result.user.id).toBeDefined();
      expect(result.user.email).toBe('new@example.com');
    });

    it('should throw error for duplicate email', async () => {
      await expect(
        authService.register({
          email: 'test@example.com', // 已存在
          username: 'newuser',
          password: 'Test123!',
        })
      ).rejects.toThrow('Email already exists');
    });
  });
});
```

#### Repository 测试示例

```typescript
// repositories/work.repository.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { WorkRepository } from './work.repository';

describe('WorkRepository', () => {
  let repository: WorkRepository;

  beforeEach(async () => {
    repository = new WorkRepository();
    await repository.clear(); // 清空测试数据
  });

  describe('create', () => {
    it('should create work', async () => {
      const work = await repository.create({
        title: '测试作品',
        userId: '1',
      });

      expect(work.id).toBeDefined();
      expect(work.title).toBe('测试作品');
    });
  });

  describe('findByUserId', () => {
    it('should return user works', async () => {
      await repository.create({ title: '作品1', userId: '1' });
      await repository.create({ title: '作品2', userId: '1' });
      await repository.create({ title: '作品3', userId: '2' });

      const works = await repository.findByUserId('1');

      expect(works).toHaveLength(2);
      expect(works[0].title).toBe('作品1');
    });
  });
});
```

---

## 4. 集成测试

### 4.1 API 集成测试

```typescript
// tests/api/auth.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import request from 'supertest';
import app from '../src/app';

describe('Auth API', () => {
  let authToken: string;

  describe('POST /api/v1/auth/register', () => {
    it('should register new user', async () => {
      const res = await request(app)
        .post('/api/v1/auth/register')
        .send({
          email: 'integration@example.com',
          username: 'integrationuser',
          password: 'Test123!',
        });

      expect(res.status).toBe(201);
      expect(res.body.success).toBe(true);
      expect(res.body.data.user.email).toBe('integration@example.com');
    });

    it('should return 400 for invalid email', async () => {
      const res = await request(app)
        .post('/api/v1/auth/register')
        .send({
          email: 'invalid-email',
          username: 'testuser',
          password: 'Test123!',
        });

      expect(res.status).toBe(400);
      expect(res.body.success).toBe(false);
    });
  });

  describe('POST /api/v1/auth/login', () => {
    it('should login with valid credentials', async () => {
      const res = await request(app)
        .post('/api/v1/auth/login')
        .send({
          email: 'test@example.com',
          password: 'Test123!',
        });

      expect(res.status).toBe(200);
      expect(res.body.data.tokens.accessToken).toBeDefined();
      authToken = res.body.data.tokens.accessToken;
    });

    it('should return 401 for invalid credentials', async () => {
      const res = await request(app)
        .post('/api/v1/auth/login')
        .send({
          email: 'test@example.com',
          password: 'wrong-password',
        });

      expect(res.status).toBe(401);
    });
  });

  describe('GET /api/v1/users/me', () => {
    it('should return current user', async () => {
      const res = await request(app)
        .get('/api/v1/users/me')
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(200);
      expect(res.body.data.email).toBe('test@example.com');
    });

    it('should return 401 without token', async () => {
      const res = await request(app)
        .get('/api/v1/users/me');

      expect(res.status).toBe(401);
    });
  });
});
```

### 4.2 LLM 集成测试

```typescript
// tests/ai/ai.service.test.ts
import { describe, it, expect } from 'vitest';
import { AIService } from '../src/ai/ai.service';

describe('AIService', () => {
  const aiService = new AIService();

  describe('continue', () => {
    it('should generate continuation', async () => {
      const result = await aiService.continue({
        content: '第一章的开始...',
        agentId: 'builtin-writer',
        modelId: 'openai:gpt-3.5-turbo',
      });

      expect(result.content).toBeDefined();
      expect(result.content.length).toBeGreaterThan(0);
    }, 30000); // 30 秒超时

    it('should use custom agent', async () => {
      const result = await aiService.continue({
        content: '科幻小说的开头...',
        agentId: 'agent-scifi',
        modelId: 'openai:gpt-3.5-turbo',
      });

      expect(result.content).toContain('科幻');
    }, 30000);
  });

  describe('rewrite', () => {
    it('should rewrite content', async () => {
      const result = await aiService.rewrite({
        content: '这是需要改写的内容',
        rewriteType: 'polish',
        agentId: 'builtin-editor',
        modelId: 'openai:gpt-3.5-turbo',
      });

      expect(result.content).toBeDefined();
      expect(result.content).not.toBe('这是需要改写的内容');
    }, 30000);
  });
});
```

---

## 5. 端到端测试

### 5.1 Playwright 配置

#### 安装
```bash
pnpm add -D @playwright/test
pnpm exec playwright install
```

#### 配置 (`playwright.config.ts`)
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

### 5.2 E2E 测试用例

#### 登录流程测试
```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Authentication', () => {
  test('should login with valid credentials', async ({ page }) => {
    await page.goto('/');

    // 点击登录按钮
    await page.click('text=登录');

    // 填写表单
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test123!');

    // 提交表单
    await page.click('button[type="submit"]');

    // 验证登录成功
    await expect(page).toHaveURL('/');
    await expect(page.locator('text=欢迎回来')).toBeVisible();
  });

  test('should show error for invalid credentials', async ({ page }) => {
    await page.goto('/login');

    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'wrong-password');
    await page.click('button[type="submit"]');

    await expect(page.locator('text=邮箱或密码错误')).toBeVisible();
  });
});
```

#### 编辑器测试
```typescript
// e2e/editor.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Editor', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test123!');
    await page.click('button[type="submit"]');
    await expect(page).toHaveURL('/');
  });

  test('should create new work', async ({ page }) => {
    // 点击新建作品
    await page.click('text=新建作品');

    // 填写标题
    await page.fill('input[name="title"]', 'E2E 测试作品');

    // 提交
    await page.click('button:has-text("创建")');

    // 验证作品创建成功
    await expect(page.locator('text=E2E 测试作品')).toBeVisible();
  });

  test('should edit chapter content', async ({ page }) => {
    // 打开作品
    await page.click('text=测试作品');

    // 点击编辑按钮
    await page.click('text=编辑');

    // 输入内容
    const editor = page.locator('[contenteditable="true"]');
    await editor.fill('这是测试内容');

    // 保存
    await page.click('button:has-text("保存")');

    // 验证保存成功
    await expect(page.locator('text=已保存')).toBeVisible();
  });

  test('should use AI continuation', async ({ page }) => {
    // 打开编辑器
    await page.goto('/editor/chapter/1');

    // 点击 AI 续写
    await page.click('button:has-text("AI 续写")');

    // 等待 AI 生成
    await page.waitForSelector('text=生成完成', { timeout: 30000 });

    // 验证内容已添加
    const editor = page.locator('[contenteditable="true"]');
    const content = await editor.textContent();
    expect(content).toContain('AI');
  });
});
```

---

## 6. 性能测试

### 6.1 前端性能测试

```typescript
// tests/performance/loaded.test.ts
import { test, expect } from '@playwright/test';

test('should load editor within 2 seconds', async ({ page }) => {
  const startTime = Date.now();

  await page.goto('/editor/chapter/1');
  await page.waitForLoadState('networkidle');

  const loadTime = Date.now() - startTime;

  expect(loadTime).toBeLessThan(2000);
});

test('should render editor smoothly', async ({ page }) => {
  await page.goto('/editor/chapter/1');

  const fps = await page.evaluate(() => {
    return new Promise((resolve) => {
      let frames = 0;
      const startTime = performance.now();

      function countFrames() {
        frames++;
        if (performance.now() - startTime < 1000) {
          requestAnimationFrame(countFrames);
        } else {
          resolve(frames);
        }
      }

      requestAnimationFrame(countFrames);
    });
  });

  expect(fps).toBeGreaterThan(30);
});
```

### 6.2 后端性能测试

```typescript
// tests/performance/api.test.ts
import { test, expect } from 'vitest';
import { measure } from '../src/utils/performance';

test('API response time should be under 200ms', async () => {
  const result = await measure(async () => {
    const response = await fetch('http://localhost:3001/api/v1/works');
    return response.json();
  });

  expect(result.duration).toBeLessThan(200);
});
```

---

## 7. 安全测试

### 7.1 认证安全测试

```typescript
// tests/security/auth.test.ts
import { test, expect } from 'vitest';
import request from 'supertest';
import app from '../src/app';

test('should reject expired token', async () => {
  const expiredToken = 'expired.jwt.token';

  const res = await request(app)
    .get('/api/v1/users/me')
    .set('Authorization', `Bearer ${expiredToken}`);

  expect(res.status).toBe(401);
});

test('should reject malformed token', async () => {
  const malformedToken = 'not-a-valid-jwt';

  const res = await request(app)
    .get('/api/v1/users/me')
    .set('Authorization', `Bearer ${malformedToken}`);

  expect(res.status).toBe(401);
});
```

### 7.2 输入验证测试

```typescript
// tests/security/validation.test.ts
import { test, expect } from 'vitest';
import request from 'supertest';
import app from '../src/app';

test('should sanitize malicious input', async () => {
  const maliciousInput = '<script>alert("XSS")</script>';

  const res = await request(app)
    .post('/api/v1/works')
    .send({ title: maliciousInput });

  expect(res.status).toBe(201);
  expect(res.body.data.title).not.toContain('<script>');
});

test('should reject SQL injection attempts', async () => {
  const sqlInjection = "'; DROP TABLE users; --";

  const res = await request(app)
    .get(`/api/v1/works/${sqlInjection}`);

  expect(res.status).toBe(404); // 应该返回 404，而不是 500
});
```

---

## 8. 测试覆盖率要求

| 类型 | 覆盖率要求 |
|------|----------|
| 工具函数 | 100% |
| 服务层 | 90% |
| 控制器 | 80% |
| 组件 | 80% |
| Hooks | 90% |
| 整体 | 70% |

---

## 9. 测试执行

### 9.1 运行所有测试

```bash
# 前端单元测试
pnpm test

# 后端单元测试
cd server && pnpm test

# E2E 测试
pnpm test:e2e

# 性能测试
pnpm test:performance

# 覆盖率报告
pnpm test:coverage
```

### 9.2 CI/CD 集成

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Run unit tests
        run: pnpm test

      - name: Run e2e tests
        run: pnpm test:e2e

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

---

## 10. 测试维护

### 10.1 测试用例更新
- 新功能必须添加测试
- Bug 修复必须添加测试用例
- 定期审查和更新测试用例
- 移除过时的测试

### 10.2 测试数据管理
- 使用独立的测试数据库
- 每次测试后清理数据
- 使用种子数据填充基础数据

---

**文档版本**: v1.0
**最后更新**: 2026-02-11
