# Novel-IDE-Web 设计文档

> 状态说明（Spec-Kit）：本文件包含 **已实现（Implemented）** 与 **规划（Planned）** 两类内容。
> - 已实现能力以 `docs/specs/**` 与仓库代码为准。
> - 规划能力必须标注 Planned，避免被误认为已落地。
## 1. 项目概述

### 1.1 项目定位
一个现代化的网页端小说编辑器，采用类 VSCode 的界面风格，集成 AI 智能写作功能。专注于提升小说创作者的写作效率，通过 AI 辅助和智能体系统降低创作门槛。

### 1.2 核心价值
- **沉浸式写作体验** - 专业的 IDE 风格界面，专注于写作
- **AI 即时协作** - AI 直接修改内容，无需用户复制粘贴
- **灵活的智能体** - 可定制 AI 助手，适应不同创作需求
- **模型自主掌控** - 服务端统一管理模型，用户无需配置

## 2. 技术架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                    Next.js 应用（Implemented）            │
│  ┌────────────────────────┐  ┌────────────────────────┐  │
│  │ UI（App Router + React）│  │ /api/v1（Route Handlers）│  │
│  │ - 登录/注册             │  │ - Auth/Works/Chapters    │  │
│  │ - 作品/章节编辑（Lexical）│  │ - 同源 success/data/error │  │
│  └────────────────────────┘  └────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                 Postgres + Redis（Implemented）           │
│  - Postgres：作品/章节/用户                                   │
│  - Redis：refresh token store（可降级内存）                    │
└─────────────────────────────────────────────────────────┘

可选复杂能力服务（Planned/按需启用）：NestJS 后端，用于 WebSocket/任务队列/worker 等需要独立伸缩的能力。
```

### 2.2 前端技术栈详解

#### 2.2.1 核心框架
- **Next.js (App Router)** - 全栈框架（Implemented）
  - 本仓库使用 Next Route Handlers 提供同源 `/api/v1/**`
  - React 版本以 `app/package.json` 为准
- **TypeScript** - 全类型覆盖，提高代码质量和开发效率

#### 2.2.2 构建工具
- **Next.js 内置** - 优化的开发和生产构建
  - Turbopack (可选) 超快构建速度
  - 增量静态生成 (ISR)
  - HMR (热模块替换) 快速响应

#### 2.2.3 编辑器核心
- **Lexical** - 面向富文本与结构化内容的可扩展编辑器
  - 适合构建章节/场景/角色引用等领域节点
  - 与 React 深度集成，插件扩展成本低
  - 可结合 Yjs 实现协同编辑与冲突处理
  - 更适合小说写作中的结构化改写与导出

#### 2.2.4 UI 组件库
- **UI 组件库**（Planned）：后续可选用 shadcn/ui 或自研组件集。
  当前 Phase 1 以最小页面与编辑器组件为主。

#### 2.2.5 状态管理
- **状态管理**（Planned）：根据后续复杂度引入（Zustand/TanStack Query 等）。

#### 2.2.6 样式方案
- **样式方案**（Planned）：如引入 Tailwind/shadcn，需要同步补齐工程化配置与设计 token。
  当前 Phase 1 以最小全局样式与页面样式为主。

#### 2.2.7 实时通信
- **实时通信**（Planned）：AI 流式输出（SSE）与协作编辑（WebSocket/Yjs）后续按需落地。
  当前 Phase 1 未实现实时通信能力。

#### 2.2.8 本地优先写作能力
- **本地优先**（Planned）：离线草稿、冲突合并与断网可写能力后续实现。
  当前 Phase 1 以在线编辑为主。

### 2.3 后端技术栈详解

#### 2.3.1 框架选择
- **Next.js Route Handlers**（Implemented）- 承接同步 REST API（同源 `/api/v1/**`）
  - 统一返回 `success/data/error`
  - 直接访问 Postgres/Redis（Node runtime）
- **NestJS**（Planned/按需启用）- 仅承接复杂能力（WebSocket/队列/worker/独立伸缩）

#### 2.3.2 数据库
- **PostgreSQL** - 关系型数据库
  - 强大的 JSON 支持
  - 全文搜索能力（FTS）
  - 事务支持
  - 通过 pgvector 支持语义检索（角色/设定上下文召回）
- **Redis** - 缓存和会话管理
  - 高性能键值存储
  - 发布订阅
  - 限流、队列
- **Meilisearch** (可选) - 全文搜索引擎
  - 更快的搜索性能
  - 更好的中文支持
  - 易于部署

#### 2.3.3 ORM
- **Drizzle ORM** - 现代数据库工具
  - 编译时类型检查
  - 更小的包体积
  - 更好的性能
  - 纯 SQL 控制
  - 增量迁移支持
  - 支持 PostgreSQL、MySQL、SQLite 等

#### 2.3.4 认证方案
- **JWT (JSON Web Token)**（Implemented）- access/refresh 双 token + Redis refresh store（支持撤销与全端登出）
- **Better Auth**（Planned）- 如后续需要更完整的账号能力再评估引入

#### 2.3.5 LLM 抽象层
（Planned）使用统一 LLM 抽象层管理模型与密钥，支持：
- OpenAI API (GPT-4, GPT-3.5)
- Anthropic Claude API
- DeepSeek API
- 通义千问 API
- 智谱 API
- 本地 Ollama
- 自定义兼容 OpenAI 格式的 API

### 2.4 扩展性设计

#### 2.4.1 插件系统（未来）
- 编辑器插件系统
- LLM 适配器插件
- 智能体插件

#### 2.4.2 微服务化（未来）
- 编辑器服务独立
- AI 服务独立
- 用户服务独立
- 便于横向扩展

#### 2.4.3 多端支持
- 响应式设计，支持平板
- 桌面客户端（Electron）
- 移动端（React Native）

## 3. 功能模块设计

### 3.1 用户系统

#### 3.1.1 注册/登录
- 邮箱注册登录
- 第三方登录（GitHub, Google, 微信）
- 忘记密码
- 登录状态持久化

#### 3.1.2 用户设置
- 个人资料
- 主题切换（深色/浅色）
- 编辑器偏好（字体、字号、行高）
- 快捷键自定义

#### 3.1.3 数据管理
- 云同步
- 本地缓存（IndexedDB）
- 导入导出

### 3.2 编辑器模块

#### 3.2.1 布局设计
```
┌─────────────────────────────────────────────────────────┐
│ 菜单栏: 文件 | 编辑 | 视图 | AI | 帮助                      │
├──────────┬─────────────────────────────────┬─────────────┤
│          │                                 │             │
│ 资源管理器│          编辑器主区域            │   大纲面板  │
│          │                                 │             │
│ - 作品集  │  ┌─────────────────────────┐   │   - 章节    │
│ - 章节   │  │                         │   │   - 角色    │
│ - 角色   │  │     正文内容编辑区       │   │   - 场景    │
│ - 场景   │  │                         │   │   - 标签    │
│ - 标签   │  │                         │   │             │
│          │  └─────────────────────────┘   │             │
│ 搜索栏   │                                 │             │
│          │                                 │             │
├──────────┴─────────────────────────────────┴─────────────┤
│ 状态栏: 字数 | 行数 | 保存状态 | AI 连接状态               │
└─────────────────────────────────────────────────────────┘
```

#### 3.2.2 核心功能
- 富文本编辑（Markdown 格式）
- 实时字数统计
- 自动保存
- 版本历史（时间线）
- 撤销/重做
- 查找替换
- 快捷键支持

#### 3.2.3 组织结构
- 作品管理
- 章节管理
- 场景标记
- 标签系统
- 角色卡片
- 世界观设定

### 3.3 AI 写作模块

#### 3.3.1 交互方式
1. **选中编辑** - 选中文本 → AI 修改
2. **光标续写** - 光标位置 → AI 继续写
3. **指令模式** - 输入指令 → AI 执行
4. **对话模式** - 与 AI 交流 → AI 建议

#### 3.3.2 AI 功能列表
- 智能续写
- 内容改写（润色、扩写、精简）
- 风格转换
- 情节建议
- 角色对话生成
- 描写增强
- 矛盾检查
- 逻辑一致性分析

#### 3.3.3 流式输出
- 实时显示 AI 输出
- 可随时停止
- 输出内容直接插入文档

#### 3.3.4 上下文管理
- 智能上下文提取（前后文）
- 角色信息上下文
- 世界观设定上下文
- 可自定义上下文范围

### 3.4 智能体系统

#### 3.4.1 智能体概念
智能体是具有特定写作风格、知识领域和行为模式的 AI 助手。

#### 3.4.2 智能体类型
1. **预设智能体**
   - 通用写作助手
   - 科幻小说专家
   - 古风小说专家
   - 悬疑小说专家
   - 甜宠小说专家
   - 校对编辑

2. **用户自定义智能体**
   - 用户可创建自己的智能体
   - 设置系统提示词
   - 配置行为参数（创意度、严谨度等）

#### 3.4.3 智能体配置
```typescript
interface Agent {
  id: string;
  name: string;
  description: string;
  systemPrompt: string;
  behavior: {
    creativity: number; // 0-1
    formality: number;  // 0-1
    detailLevel: number; // 0-1
  };
  knowledge: string[]; // 知识领域
  examples?: string[]; // 示例
  modelPreference?: string; // 模型偏好
  isBuiltin: boolean;
  userId?: string; // 创建者
}
```

#### 3.4.4 智能体市场（未来）
- 社区分享智能体
- 智能体评分
- 智能体分类

### 3.5 LLM 模型管理

#### 3.5.1 统一抽象层
```typescript
interface LLMProvider {
  name: string;
  apiEndpoint: string;
  apiKey: string;
  models: LLMModel[];
  supportsStreaming: boolean;
  maxTokens: number;
}

interface LLMModel {
  id: string;
  name: string;
  provider: string;
  contextWindow: number;
  pricing?: {
    input: number; // per 1k tokens
    output: number;
  };
}
```

#### 3.5.2 模型配置
通过后端配置文件统一管理：
```yaml
llm:
  providers:
    openai:
      api_key: ${OPENAI_API_KEY}
      models:
        - gpt-4-turbo
        - gpt-3.5-turbo
    anthropic:
      api_key: ${ANTHROPIC_API_KEY}
      models:
        - claude-3-opus
        - claude-3-sonnet
    deepseek:
      api_key: ${DEEPSEEK_API_KEY}
      models:
        - deepseek-chat
    local:
      base_url: http://localhost:11434
      models:
        - llama3
```

#### 3.5.3 模型路由策略
- 智能体可以指定模型偏好
- 自动降级（高可用性）
- 负载均衡
- 成本优化

### 3.6 导出模块
- Markdown 导出
- TXT 导出
- PDF 导出
- EPUB 导出（未来）
- Word 导出（未来）

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  username VARCHAR(100) UNIQUE NOT NULL,
  avatar_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.2 作品表 (works)
```sql
CREATE TABLE works (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  cover_url VARCHAR(500),
  settings JSONB, -- 作品级设置
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.3 章节表 (chapters)
```sql
CREATE TABLE chapters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID REFERENCES works(id) ON DELETE CASCADE,
  title VARCHAR(255),
  content TEXT,
  order_index INTEGER NOT NULL,
  word_count INTEGER DEFAULT 0,
  tags TEXT[],
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.4 版本历史表 (version_history)
```sql
CREATE TABLE version_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chapter_id UUID REFERENCES chapters(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  word_count INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.5 角色表 (characters)
```sql
CREATE TABLE characters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_id UUID REFERENCES works(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  avatar_url VARCHAR(500),
  attributes JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.6 智能体表 (agents)
```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  system_prompt TEXT NOT NULL,
  behavior JSONB NOT NULL,
  knowledge TEXT[],
  examples TEXT[],
  model_preference VARCHAR(100),
  is_builtin BOOLEAN DEFAULT FALSE,
  is_public BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 4.2 索引设计
```sql
-- 常用查询索引
CREATE INDEX idx_chapters_work ON chapters(work_id);
CREATE INDEX idx_chapters_order ON chapters(work_id, order_index);
CREATE INDEX idx_version_history_chapter ON version_history(chapter_id, created_at DESC);
CREATE INDEX idx_agents_user ON agents(user_id);
CREATE INDEX idx_agents_public ON agents(is_public) WHERE is_public = TRUE;
```

## 5. API 设计

### 5.1 RESTful API 基础路径
```
/api/v1/auth      - 认证相关
/api/v1/users     - 用户相关
/api/v1/works     - 作品相关
/api/v1/chapters  - 章节相关
/api/v1/ai        - AI 功能
/api/v1/agents    - 智能体相关
```

### 5.2 核心 API 端点

#### 5.2.1 认证 (Auth)
- `POST /api/v1/auth/register` - 注册
- `POST /api/v1/auth/login` - 登录
- `POST /api/v1/auth/logout` - 登出
- `POST /api/v1/auth/refresh` - 刷新令牌

#### 5.2.2 作品 (Works)
- `GET /api/v1/works` - 获取作品列表
- `POST /api/v1/works` - 创建作品
- `GET /api/v1/works/:id` - 获取作品详情
- `PUT /api/v1/works/:id` - 更新作品
- `DELETE /api/v1/works/:id` - 删除作品

#### 5.2.3 章节 (Chapters)
- `GET /api/v1/works/:workId/chapters` - 获取章节列表
- `POST /api/v1/works/:workId/chapters` - 创建章节
- `GET /api/v1/chapters/:id` - 获取章节内容
- `PUT /api/v1/chapters/:id` - 更新章节
- `DELETE /api/v1/chapters/:id` - 删除章节
- `GET /api/v1/chapters/:id/history` - 获取版本历史

#### 5.2.4 AI (AI)
- `POST /api/v1/ai/continue` - 续写
- `POST /api/v1/ai/rewrite` - 改写
- `POST /api/v1/ai/generate` - 指令生成
- `POST /api/v1/ai/chat` - 对话模式

#### 5.2.5 智能体 (Agents)
- `GET /api/v1/agents` - 获取智能体列表
- `GET /api/v1/agents/builtin` - 获取预设智能体
- `POST /api/v1/agents` - 创建智能体
- `GET /api/v1/agents/:id` - 获取智能体详情
- `PUT /api/v1/agents/:id` - 更新智能体
- `DELETE /api/v1/agents/:id` - 删除智能体

### 5.3 WebSocket 事件

#### 5.3.1 AI 流式输出
```javascript
// 客户端发送
socket.emit('ai:generate', {
  agentId: 'xxx',
  content: '续写这段文字...',
  context: {...}
});

// 服务端返回
socket.on('ai:chunk', (chunk) => {
  // 收到文本片段
});

socket.on('ai:complete', (result) => {
  // 生成完成
});

socket.on('ai:error', (error) => {
  // 错误
});
```

## 6. 安全设计

### 6.1 认证与授权
- JWT 认证
- Token 过期机制
- Refresh Token 刷新
- 密码加密 (bcrypt)

### 6.2 数据保护
- HTTPS 强制
- 敏感数据加密
- SQL 注入防护 (Drizzle 参数化查询)
- XSS 防护 (React 自动转义)

### 6.3 API 安全
- 请求限流
- CORS 配置
- 输入验证
- 敏感操作日志

### 6.4 AI 安全
- Prompt 注入防护
- 内容过滤
- 输出长度限制
- 成本控制

## 7. 性能优化

### 7.1 前端优化
- 虚拟滚动（大文档）
- 代码分割
- 懒加载
- 缓存策略（Service Worker）
- IndexedDB 本地存储

### 7.2 后端优化
- Redis 缓存
- 数据库索引优化
- 连接池（Fastify 内置）
- CDN 加速（静态资源）
- 批量操作

### 7.3 AI 调用优化
- 请求合并
- 响应流式传输
- 智能上下文压缩
- 结果缓存

## 8. 开发计划

### 8.1 Phase 1: 基础框架 (2-3 周)
- [ ] 项目脚手架搭建
- [ ] 数据库设计与迁移
- [ ] 基础认证系统
- [ ] 基础编辑器界面

### 8.2 Phase 2: 核心编辑功能 (2-3 周)
- [ ] 章节管理 CRUD
- [ ] 实时保存
- [ ] 版本历史
- [ ] 基础样式

### 8.3 Phase 3: AI 集成 (3-4 周)
- [ ] LLM 抽象层
- [ ] 单模型集成
- [ ] 流式输出
- [ ] 基础 AI 功能（续写、改写）

### 8.4 Phase 4: 智能体系统 (2-3 周)
- [ ] 预设智能体
- [ ] 自定义智能体
- [ ] 智能体管理界面

### 8.5 Phase 5: 多模型支持 (2 周)
- [ ] 多 Provider 集成
- [ ] 模型配置系统
- [ ] 模型切换

### 8.6 Phase 6: 高级功能 (持续)
- [ ] 搜索功能
- [ ] 标签系统
- [ ] 角色管理
- [ ] 导出功能
- [ ] 协作编辑

## 9. 技术债务与风险

### 9.1 潜在风险
- LLM API 稳定性依赖
- 大文档性能挑战
- 实时协作复杂度
- 成本控制

### 9.2 缓解措施
- 多模型冗余
- 性能监控
- 渐进式开发
- 成本预警

## 10. 未来规划

### 10.1 短期目标
- 完善 MVP
- 用户反馈收集
- 性能优化

### 10.2 中期目标
- 插件系统
- 智能体市场
- 社区功能

### 10.3 长期目标
- AI 训练（基于用户数据）
- 跨平台支持
- 企业版本

---

**文档版本**: v1.0
**创建日期**: 2026-02-11
**最后更新**: 2026-02-11
