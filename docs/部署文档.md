# Novel-IDE-Web 部署文档

> 说明：仓库当前处于 Phase 1 MVP 开发中，推荐优先使用 `docker/docker-compose.yml` 进行本地/单机部署。

## 0. Phase 1 快速部署（推荐）

### 0.1 依赖
- Docker Desktop / Docker Engine
- Docker Compose v2

### 0.2 一键启动（PostgreSQL + Redis + migrate + app）

```bash
cp .env.example .env
docker compose -f docker/docker-compose.yml --env-file .env up --build -d
```

默认端口（可在 `.env` 覆盖）：
- app: 3000
- server: 3001（可选 profile）
- postgres: 5432
- redis: 6379

访问：
- 前端: http://localhost:3000
- 同源 API: http://localhost:3000/api/v1
- API 健康检查: http://localhost:3000/api/v1/health
- 前端入口：打开 `/` 会自动跳转到 `/login` 或 `/works`

如需启用可选后端（复杂能力服务，NestJS）：
```bash
docker compose -f docker/docker-compose.yml --profile complex --env-file .env up --build -d
```

## 1. 本地开发（不使用 Docker 跑 Node 服务）

### 1.1 依赖
- Node.js 20.9+
- pnpm
- PostgreSQL 15+
- Redis 7+

### 1.2 安装依赖

```bash
pnpm install
```

### 1.3 环境变量

```bash
cp .env.example .env
cp app/.env.example app/.env.local
cp server/.env.example server/.env
```

关键变量说明：
- `app/.env.local`
  - `DATABASE_URL`：PostgreSQL 连接串（Next Route Handlers 直接访问 DB）
  - `REDIS_URL`：Redis 连接串（refresh token 存储）
  - `JWT_ACCESS_SECRET` / `JWT_REFRESH_SECRET`：JWT 密钥
  - `ACCESS_TOKEN_TTL` / `REFRESH_TOKEN_TTL`：token 有效期（秒）
- `server/.env`
  - 同上（仅当需要启动可选 Nest 后端时才需要配置）

### 1.4 数据库迁移（Drizzle）

当你修改了 schema（当前事实来源是 `packages/server-core/src/db/schema.ts`）后：

```bash
pnpm --filter server db:generate
pnpm --filter server db:migrate
```

### 1.5 启动服务（两个终端）

```bash
pnpm dev:app
```

`app` 开发服务默认使用 3000；如果 3000 被占用，会自动选择 3000-3100 的可用端口（跳过 3001，避免与后端冲突）。

可选：启动 Nest 后端（复杂能力服务）：
```bash
pnpm dev:server
```

如果本地没有启动 Redis（默认 `localhost:6379`），开发环境会自动降级为内存实现以便启动；但 refresh token 的撤销/全量登出能力将不持久化。

## 2. 生产部署建议
- `app` 建议以容器方式部署，前置 Nginx/Traefik 做反代与 TLS；同源 `/api/v1` 由 Next Route Handlers 提供。
- 仅当需要复杂能力（WS/队列/worker 等）时再部署 `server`（NestJS）并独立扩缩容。
- 生产环境请务必替换 JWT 密钥，并使用独立的 PostgreSQL/Redis 实例与持久化卷。
